<layout name="teacher_layout_withouticon"/>
<link href="__PUBLIC_METRO__/css/app/table_list1.css?v=2.0" type="text/css" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="__PUBLIC__/umeditor/third-party/mathquill/mathquill.css">
<script type="text/javascript" src="__PUBLIC__/umeditor/third-party/mathquill/mathquill.min.js"></script>
<link href="__PUBLIC__/js/fine-uploader/fine-uploader-new.css" rel="stylesheet" type="text/css"/> 

<style>
    .list_avatar {
        width: 36px;
        height: 36px;
        border-radius: 6px;
    }

    h3 {
        text-align: center;
    }
    .qq-uploader{
        min-height:100px;
    }

/*
    .ctrl_box {
        position: absolute;
        right: 20px;
        top: 192px;
        z-index: 100;
        width: 40px;
        height: 80px;
    }
*/

    .ctrl_box img {
        display: inline-block;
        width: 30px;
        height: 30px;
        margin-bottom: 15px;
        cursor: pointer;
    }

  
	
	/*-----------英语老师上传文件-------------*/
	.fileUnload {
		padding: 0 0 10px 20px;
	}
	
	.fileText {
		border:1px solid #ccc;
		width: 200px;
	}
	
	.fileButton {
		border: 1px solid #ccc;
		background: #fff;
		letter-spacing: 4px;
	}
</style>

<div style="margin-bottom: 12px;">
    <a href="javascript:window.history.go(-1)" title="返回" class="btn btnReturn1">返回</a>
</div>

<div data-text="活动内容">
    <div class="listview set-border padding10">
        <div class="padding10">
            <h3>{$data.title}</h3>

            <div class="padding10" style="font-size:16px;font-family:'黑体';overflow:hidden;">
                <div style="float: left;width: 400px;">
                    {$data.create_at|date="Y-m-d",###} {$data.publisher}
                </div>
                <div style="float: right;width: 400px;text-align: right;">
                    面向 {$data.stakeholder}
                </div>
            </div>
            <div class="padding10" style="font-size:16px;font-family:'黑体';overflow:hidden;">
                <div style="float: left;width: 400px;">
                    京版活动-北京出版社组织
                </div>
                <div style="float: right;">
                    <div class="ctrl_box">
                        <if condition="$existedZan eq 'yes'">
                            <img id="zanIcon" src="__PUBLIC__/img/icon/zaned.png">
                            <else/>
                            <img id="zanIcon" src="__PUBLIC__/img/icon/zan.png">
                        </if>
                        <if condition="$existedFavor eq 'yes'">
                            <img id="favorIcon" src="__PUBLIC__/img/icon/favored.png">
                            <else/>
                            <img id="favorIcon" src="__PUBLIC__/img/icon/favor.png">
                        </if>
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;word-break: break-all;padding: 10px 35px 10px 10px; border: 1px solid #bababa;
        background: #f4f4f4;">{$data.content}</div>
        </div>
    </div>
</div>

<!--英语老师上传文件-->
<if condition="$data['is_upload'] eq '1'">
    <if condition="$registered eq 'no'">
        <div class="fileUnload">
            <span>请选择您要上传的ppt：</span>
                <!--<input class="fileText" type="text" name="upfile" id="upfile">  
                <input class="fileButton" type="button" value="浏览" onclick="path.click()">  
                <input type="file" id="path" style="display:none" accept=".ppt,.pptx" onchange="upfile.value=this.value">
                -->
                <div id="fine-uploader">

                </div>
        </div>
    <else />
        <div class="fileUnload"><a href="{$oss_path}{$file_path}">点击查看附件</a></div>
    </if>
</if>
<form id="info-list" action="__URL__/reportActivity" method="post">
    <div style="padding:5px">
        <input type="hidden" class="file_path" name="file_path"/>
        
        <input type="hidden" name="activity_id" value="{$data.id}">
        <textarea class="form-control" name="register_info" rows="4" style="width: 100%;"
                  placeholder="填写报名信息"></textarea>

        <div style="text-align: center;margin-top: 10px;">
            <if condition="$registered eq 'no'">
                <button type="submit" class="btn btn1before" style="border: 1px solid #CD7C7E;">我要报名</button>
                <else/>
                <button disabled="disabled" class="btn btn1backgrondNone" style="border: 1px solid #CD7C7E;">已报名</button>
            </if>
        </div>
    </div>

</form>
</if>


<script src="__PUBLIC__/js/fine-uploader/fine-uploader.js" type="text/javascript"></script>
<script type="text/template" id="qq-template">
        <div class="qq-uploader-selector qq-uploader"  qq-drop-area-text="Drop files here">
            <div class="qq-total-progress-bar-container-selector qq-total-progress-bar-container">
                <div role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="qq-total-progress-bar-selector qq-progress-bar qq-total-progress-bar"></div>
            </div>
            <div class="qq-upload-drop-area-selector qq-upload-drop-area" qq-hide-dropzone>
                <span class="qq-upload-drop-area-text-selector"></span>
            </div>
            <div class="qq-upload-button-selector qq-upload-button">
                <div>上传文件</div>
            </div>
            <span class="qq-drop-processing-selector qq-drop-processing">
                <span>Processing dropped files...</span>
                <span class="qq-drop-processing-spinner-selector qq-drop-processing-spinner"></span>
            </span>
            <ul class="qq-upload-list-selector qq-upload-list" aria-live="polite" aria-relevant="additions removals">
                <li>
                    <div class="qq-progress-bar-container-selector">
                        <div role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="qq-progress-bar-selector qq-progress-bar"></div>
                    </div>
                    <span class="qq-upload-spinner-selector qq-upload-spinner"></span>
                    <img class="qq-thumbnail-selector" qq-max-size="100" qq-server-scale>
                    <span class="qq-upload-file-selector qq-upload-file"></span>
                    <span class="qq-edit-filename-icon-selector qq-edit-filename-icon" aria-label="Edit filename"></span>
                    <input class="qq-edit-filename-selector qq-edit-filename" tabindex="0" type="text">
                    <span class="qq-upload-size-selector qq-upload-size"></span>
                    <button type="button" class="qq-btn qq-upload-cancel-selector qq-upload-cancel">Cancel</button>
                    <button type="button" class="qq-btn qq-upload-retry-selector qq-upload-retry">Retry</button>
                    
                    <span role="status" class="qq-upload-status-text-selector qq-upload-status-text"></span>
                </li>
            </ul>

            <dialog class="qq-alert-dialog-selector">
                <div class="qq-dialog-message-selector"></div>
                <div class="qq-dialog-buttons">
                    <button type="button" class="qq-cancel-button-selector">Close</button>
                </div>
            </dialog>

            <dialog class="qq-confirm-dialog-selector">
                <div class="qq-dialog-message-selector"></div>
                <div class="qq-dialog-buttons">
                    <button type="button" class="qq-cancel-button-selector">No</button>
                    <button type="button" class="qq-ok-button-selector">Yes</button>
                </div>
            </dialog>

            <dialog class="qq-prompt-dialog-selector">
                <div class="qq-dialog-message-selector"></div>
                <input type="text">
                <div class="qq-dialog-buttons">
                    <button type="button" class="qq-cancel-button-selector">Cancel</button>
                    <button type="button" class="qq-ok-button-selector">Ok</button>
                </div>
            </dialog>
        </div>
    </script>
    
<script> 
    var activity_id="{$activity_id}";   
    var uploadInfo={};
    function changeInputFilter(){
        var acceptStr = $('#type').find("option:selected").attr('extval');
        $(':file').attr('accept',acceptStr);
    }
    changeInputFilter();
    
    function onFileCheck(){
        if($('li').hasClass('qq-upload-fail')){
            alert('有文件上传错误');
            return false;
        }
        return true;
    }
    var uploader = new qq.FineUploader({
        debug: false,
        element: document.getElementById('fine-uploader'),
        request1Enable : false,  
        multiple: false, 
        
        request: { 
            endpointnum: 0,
            endpoint: 'index.php?m=Home&c=Teach&a=upload_activity_file&activity_id='+activity_id,
            params:{},
            inputName:'file[]',							
        },
        deleteFile: {
            enabled: true,
            endpoint: '/uploads'				
        },
        retry: {
           enableAuto: true
        },
        onCancel: function(id){
            delete uploadInfo[id];
        },
        responseCallBack: function(id,specNum,xhr){     
            //这里每次进行设置
            $(".qq-upload-button").find(':file').attr('accept','.ppt,.pptx') 
            
            var result;
            try{
                result = JSON.parse(xhr.responseText);
            }
            catch(e){
                alert('上传失败!错误原因'+e); 
                return false;
            }
            if(specNum == 0){			  
              if(result.code == 0){ 
                    if(typeof(uploadInfo[id])== 'undefined'){
                        uploadInfo[id] = {};
                    }
                    uploadInfo[id]['file_path'] = result.res;
                    $(".file_path").val(result.res);
                    
                    return true;
               }else{ 
                    alert(result.msg);
               }
            } 
            return false;
        }			
    });  
    function setFileAccept(){   
        if($(".qq-upload-button").find(':file').length==false){
            setTimeout("setFileAccept()",1000);
        }else{
            $(".qq-upload-button").find(':file').attr('accept','.ppt,.pptx')
        }
    }
    setFileAccept();
</script>

<script>
    $(function () {
        $('#zanIcon').click(function () {
            $.get('__URL__/zanActivity', {social_activity_id: '{$data.id}'}, function (res) {
                if (res == 'success') {
                    $('#zanIcon').attr('src', '__PUBLIC__/img/icon/zaned.png');
                    $.notify({
                        title: '提示',
                        message: '点赞成功'
                    }, {
                        type: 'success',
                        placement: {
                            from: "top",
                            align: "center"
                        }
                    });
                } else {
                    $('#zanIcon').attr('src', '__PUBLIC__/img/icon/zan.png');
                    $.notify({
                        title: '提示',
                        message: res
                    }, {
                        type: 'warning',
                        placement: {
                            from: "top",
                            align: "center"
                        }
                    });
                }
            });
        });

        $('#favorIcon').click(function () {
            $.get('__URL__/favorActivity', {social_activity_id: '{$data.id}'}, function (res) {
                if (res == 'success') {
                    $('#favorIcon').attr('src', '__PUBLIC__/img/icon/favored.png');
                    $.notify({
                        title: '提示',
                        message: '收藏成功'
                    }, {
                        type: 'success',
                        placement: {
                            from: "top",
                            align: "center"
                        }
                    });
                } else {
                    $('#favorIcon').attr('src', '__PUBLIC__/img/icon/favor.png');
                    $.notify({
                        title: '提示',
                        message: res
                    }, {
                        type: 'warning',
                        placement: {
                            from: "top",
                            align: "center"
                        }
                    });
                }
            });
        });
    });
</script>
<script src="__PUBLIC__/js/jquery.form.js"></script>
<script>
    $(function(){
    var options = {
    success:    showResponse,  // post-submit callback
    resetForm:  false,
    dataType:  'json'
    }; 
    var is_upload="{$data.is_upload}";  
    
    // bind to the form's submit event
    $('#info-list').submit(function() {
        //判断
        if(is_upload==1){
            if($('.qq-upload-success').length==0){
                alert('请上传附件');
                return false;
            }
            if($(".file_path").val()==''){
                alert('请上传附件');
                return false;
            }
        }
        //
        
    $(this).ajaxSubmit(options);
    return false;
    });
});
function showResponse(responseText, statusText) {
    switch(responseText.code)
    {
    case 0: //success
              alert(responseText.msg);
              var url = "{:U('Teach/myActivities')}";
              window.location.href = url;

    break;

    default: alert(responseText.msg);
    break;
    }
}
</script>
</script>