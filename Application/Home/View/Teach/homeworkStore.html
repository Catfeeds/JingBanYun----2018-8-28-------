<layout name="teacher_layout_3" />
<!--<script type="text/javascript" src="http://cdn.bootcss.com/jquery-validate/1.15.0/jquery.validate.min.js"></script>-->
<script src="__PUBLIC__/js/exercise/sha1.js?" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.validate.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.validate.msg.js"></script>
<script src="__PUBLIC__/js/exercise/render_2.js?" type="text/javascript"></script>
<link type="text/css" rel="stylesheet" href="__PUBLIC__/umeditor/third-party/mathquill/mathquill.css" />
<script type="text/javascript" src="__PUBLIC__/umeditor/third-party/mathquill/mathquill.js"></script>
<link href="__PUBLIC_THEME__/stylesheets/exercise.css?v=2" rel="stylesheet" type="text/css" />
<script src='https://player.polyv.net/script/polyvplayer.min.js'></script>
<script src="http://apps.bdimg.com/libs/jquery/1.10.1/jquery.js" type="text/javascript"></script>

<style>
	.form_section {
		margin-bottom: 12px;
	}
	
	.exerciseChapterWrapper {
		margin: 20px 0;
		padding: 8px;
		cursor: pointer;
		border: 1px solid #ccc;
	}
	
	.exerciseChapterWrapper.selected {
		background: green;
		color: #fff
	}
	
	.main_head {
		padding: 17px;
	}
	
	.btn_copy {
		color: #595757;
		background-color: #fff;
		border: 1px solid #E9C232;
		font-weight: 600;
	}
	
	.checkbox_choice {
		width: 20px;
		height: 20px;
	}
	
	.a-control {
		display: block;
		width: 50%;
		height: 34px;
		padding: 6px 12px;
		font-size: 14px;
		line-height: 1.428571429;
		color: #555555;
		background-color: white;
		background-image: none;
		border: 1px solid #cccccc;
		border-radius: 4px;
		-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
		box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
		-webkit-transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		-o-transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		text-decoration: none;
		margin-bottom: 10px;
	}
	
	#navThumImg1,
	#navThumImg3,
	#navThumImg5 {
		-moz-transform: rotate(20deg);
		-webkit-transform: rotate(20deg);
		transform: rotate(20deg);
	}
	
	#navThumImg2,
	#navThumImg4 {
		-moz-transform: rotate(-20deg);
		-webkit-transform: rotate(-20deg);
		transform: rotate(-20deg);
	}
	
	#navThumImg1:hover,
	#navThumImg3:hover,
	#navThumImg5:hover {
		-moz-animation: rotate_z 0.8s infinite ease;
		-webkit-animation: rotate_z 0.8s infinite ease;
		animation: rotate_z 0.8s infinite ease;
	}
	
	#navThumImg2:hover,
	#navThumImg4:hover {
		-moz-animation: rotate_f 0.8s infinite ease;
		-webkit-animation: rotate_f 0.8s infinite ease;
		animation: rotate_f 0.8s infinite ease;
	}
	
	@-moz-keyframes rotate_z {
		0% {
			-moz-transform: rotate(20deg);
		}
		100% {
			-moz-transform: rotate(360deg);
		}
	}
	
	@-webkit-keyframes rotate_z {
		0% {
			-webkit-transform: rotate(20deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}
	
	@keyframes rotate_z {
		0% {
			transform: rotate(20deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
	
	@-moz-keyframes rotate_f {
		0% {
			-moz-transform: rotate(20deg);
		}
		100% {
			-moz-transform: rotate(360deg);
		}
	}
	
	@-webkit-keyframes rotate_f {
		0% {
			-webkit-transform: rotate(20deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}
	
	@keyframes rotate_f {
		0% {
			transform: rotate(20deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
	
	#selectSingleExercises,
	#selectAllExercises {
		width: 20px;
		height: 20px;
	}
	
	.layui-layer-title {
		background: #E9C232;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px
	}
	
	.questionWrapper {
		margin-top: 80px
	}
	
	.copy_right {
		padding: 15px;
	}
	
	.collectImg {
		margin-left: 100px;
		cursor: pointer;
	}
	
	.collectSuccess {
		width: 464px;
		height: 272px;
		background: url(__PUBLIC__/img/material/collectSuccess.png) no-repeat center;
		background-size: 100% 100%;
		position: fixed;
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		margin: auto;
		z-index: 20161003;
		color: #666;
		font-size: 16px;
		display: none;
	}

	.btnBottom {
		margin-top: 190px;
		text-align: center;
	}
		
	.yesBtn {
		background-color: #28D0C1;
		border: 1px solid transparent;
		border-radius: 6px;
		color: white;
		font-size: 22px;
		padding: 6px 33px 6px 38px;
		letter-spacing: 5px;
	}

	.yesBtn:hover {
		background-color: #209994;
	}
</style>

<div class="main_opr">
	<a href="{:U('TeachmulHomework/mulHomework')}" title="语音作业" class="btn btn-main-opr">语音作业</a>
	<a href="{:U('Teach/homework')}" title="习题作业" class="btn btn-main-opr">习题作业</a>
	<a href="javascript:;" title="习题库" class="btn btn-main-opr" style="background:#fff;">习题库</a>
	<a href="{:U('Teach/wrongHomeworkList')}" title="错题集" class="btn btn-main-opr">错题集</a>
</div>

<form action="__URL__/assignHomework" method="post" data-on-error-input="notifyOnErrorInput" data-show-error-hint="true" name="Myform" id="Myform" onsubmit="return check()">
	<!--<input type="hidden" name="exerciseChapterId" id="exerciseChapterId">-->
	<input type="hidden" name="exercise_ids" id="exerciseList">
	<div class="row">
		<div class="form_section col-md-2">
			<label for="grade_id">年级</label>
			<div class="input-control text full-size">
				<select id="grade_id" name="grade_id" class="form-control" required="">
					<option value="">-请选择-</option>
					<volist name="grade_list" id="grade_item" empty="">
						<option value="{$grade_item.id}" <if condition="$grade_item['id']==$data['grade_id']">selected</if>>{$grade_item.grade}</option>
					</volist>
				</select>
			</div>
		</div>

		<div class="form_section col-md-2">
			<label for="course_id">学科</label>
			<div class="input-control text full-size">
				<select id="course_id" name="course_id" class="form-control" required>
					<option value="">-请选择-</option>
					<volist name="courses" id="dataCourse" empty="">
						<option value="{$dataCourse.id}">{$dataCourse.code} : {$dataCourse.course_name}
						</option>
					</volist>
				</select>
			</div>
		</div>

		<div class="form_section col-md-2">
			<label for="textbook_id">教材分册</label>
			<div class="input-control text full-size">
				<select id="textbook_id" name="textbook_id" required="" class="form-control">
					<option value="">-请先选择学科和年级-</option>
				</select>
			</div>
		</div>
		
		<div class="col-md-2">
			<label for="chapter">章</label>
			<div class="input-control text full-size">
				<select name="" id="chapter" class="form-control">
					<option value="0">请选择章</option>
				</select>
			</div>
		</div>
		
		<div class="col-md-2">
			<label for="section">节</label>
			<div class="input-control text full-size">
				<select name="" id="section" class="form-control">
					<option value="0">请选择节</option>
				</select>
			</div>
		</div>
		
		<div class="col-md-2">
            <label style="width: 100%;">&nbsp;</label>
            <button type="button" class="btn btn-primary search_homework" style="display: block;float:right;">搜索</button>
        </div>
	</div>
</form>

<!-----------------添加习题-------------------->
<div class="copy_right" id="add_homework">
	<div class="row" style="margin-bottom: 10px;">
		<div class="col-md-10" style="word-break: break-all">已选择习题：<span id="form_selected_exercise"></span></div>
		<div class="col-md-2" style="text-align: right;">
			<a href="javascript:;" title="创建作业" class="btn btn-primary" style="background:#E9C232 !important;">创建作业</a>
		</div>
	</div>
	<!--------------------章节部分---------------------------->
	<div class="from_after">
<!--
		<a href="{:U('Teach/homeworkChoose')}" class="a-control">第一章 第三节 （双击预览习题）</a>
        <a href="{:U('Teach/homeworkChoose')}" class="a-control">第二章 第五节 （双击预览习题）</a>
-->
	</div>
</div>

<!--收藏成功-->
<div class="collectSuccess">
	<div class="btnBottom">
		<button class="yesBtn" id="">确定</button>
	</div>
</div>

<script type="text/javascript" src="__PUBLIC__/js/layer/layer.js"></script>
<script>
	var exercises = [];

	var startTime = 1;
	var isShowCorrectAnswer = false;

	//年级发生改变
	var option = "<option value='0'>-请选择-</option>  ";
	$("#grade_id").change(function () {
		var val = $("#grade_id").val();
		$("#class_id option:not(:eq(0))").remove();
		clear_style();
		hide_style();

		//清除所有 
		$("#course_id option:not(:eq(0))").remove();
		$("#textbook_id option:not(:eq(0))").remove();
		if (val == 0) {

		} else {
			$.getJSON("index.php?m=Home&c=Teach&a=getGradeClass", {
				'id': val
			}, function (msg) {
				var length = msg.length;
				for (var i = 0; i < length; i++) {
					var temp = $(option).clone(true);
					$(temp).text(msg[i].name);
					$(temp).val(msg[i].id);
					$("#class_id").append(temp);
				}
			});
			$.getJSON("index.php?m=Home&c=Teach&a=getClassCourse", {
				'id': val
			}, function (msg) {
				var length = msg.length;
				for (var i = 0; i < length; i++) {
					var temp = $(option).clone(true);
					$(temp).text(msg[i].course_name);
					$(temp).val(msg[i].id);
					$("#course_id").append(temp);
				}
			});

		}

	});

	//清除添加之后的样式
	function clear_style() {
		$("#chapter option:not(:eq(0))").remove();
		$("#section option:not(:eq(0))").remove();
		$('.from_after').find('a').remove();
	}

	function hide_style() {
		$("#add_homework").show();
		$("#copy_homework").hide();
	}

	//学科发生改变
	$("#course_id").change(function () {
		var course_val = $("#course_id").val();
		var grade_val = $("#grade_id").val();
		$("#textbook_id option:not(:eq(0))").remove();
		clear_style();
		hide_style();
		if (course_val == 0) {
			return false;
		}
		$.getJSON("index.php?m=Home&c=Teach&a=getCourseTextbook", {
			'course_id': course_val,
			'grade_id': grade_val
		}, function (msg) {
			var length = msg.length;
			for (var i = 0; i < length; i++) {
				var temp = $(option).clone(true);
				$(temp).text(msg[i].name);
				$(temp).val(msg[i].id);
				$("#textbook_id").append(temp);
			}
		});
	});


	//教材发生改变
	$("#textbook_id").change(function () {
		var val = $("#textbook_id").val();
		clear_style();
		hide_style();
		if (val == 0) {
			return false;
		}
		$.getJSON("index.php?m=Home&c=Teach&a=getTextbookChapter", {
			'id': val
		}, function (msg) {
			var length = msg.length;
			for (var i = 0; i < length; i++) {
				var temp = $(option).clone(true);
				$(temp).text(msg[i].chapter);
				$(temp).val(msg[i].id);
				$("#chapter").append(temp);
			}
		});
	});

	//章发生改变
	$("#chapter").change(function () { //section
		var val = $("#chapter").val();
		var text = $("#chapter").find("option:selected").text();
		var textbook_id = $("#textbook_id").val();

		$("#section option:not(:eq(0))").remove();
		$.getJSON("index.php?m=Home&c=Teach&a=getExerciseChapter", {
			'chapter': text,
			'textbook_id': textbook_id
		}, function (msg) {
			var length = msg.length;
			for (var i = 0; i < length; i++) {
				var temp = $(option).clone(true);
				$(temp).text(msg[i].festival);
				$(temp).val(msg[i].id);
				$("#section").append(temp);
			}
		});
	});

	var temp_a = "<a href='javascript:void(0)' attr_id='0' onclick=\"actionClick(this)\" class='a-control'>第二章 第五节 （双击预览习题）</a>";
	//节发生改变
	$("#section").change(function () {
		var textbook_id = $("#textbook_id").val();
		var chapter = $("#chapter").find("option:selected").text();
		var festival = $("#section").find("option:selected").text();
		$(".from_after").find("a").remove();
		hide_style();
		$.getJSON("index.php?m=Home&c=Teach&a=getExerciseChapterTitle", {
			'textbook_id': textbook_id,
			'chapter': chapter,
			'festival': festival
		}, function (msg) {
			global_I = 0;
			var length = msg.length;
			for (var i = 0; i < length; i++) {
				var temp = $(temp_a).clone(true);
				$(temp).text(msg[i].chapter + ' ' + msg[i].festival + ' ' + msg[i].title);
				$(temp).attr("attr_id", msg[i].id); //
				$(".from_after").append(temp);
			}
		});
	});

	//点击跳转
	function actionClick(obj) {
		//var val=$("#section").val();
		/*
		var val=$(this).attr('attr_id'); 

		$("#add_homework").hide();
		$("#copy_homework").show();*/
		$('#create_outclass_homework .exerciseChapterWrapper').removeClass('selected');
		$(obj).addClass('selected');
		choosedExerciseLibraryChapter = $(obj).attr('attr_id');
		//习题渲染
		//
		var tpl = '<div style="font-size: 18px;position: fixed;z-index:9999;left: 0;top:44px;width: 100%;margin-top:-4px;"><div><button class="sub_opr btnReturn3 layer-open layui-layer-close" style="margin: 10px 0 0 15px;width:72px;border-radius:8px;font-size:16px;position: initial;">返回</button></div><div style="margin:10px 0 10px 10px"> 选择习题@ ' + $(obj).html() + ',</div><div style="width: 140px;float:left;margin-left:10px;background:#fff"><label><input id="selectAllExercises" onclick="onClick_SelectAllTheExerciseInALibrary(this)" type="checkbox">全选</label>&nbsp;&nbsp;已选择：</div><div style="width:640px;float:left;background:#fff"><span id="form_exercise_chooser_selected" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px"></span></div>&nbsp;&nbsp;<div style="width:70px;float:right;"><button class="sub_opr btnReturn3" style="float: right;margin: 0 15px 0 0;width:72px;border-radius:8px;font-size:16px;" onclick="onClick_ConfirmTheSelectedExerciseInALibrary();">确认</button></div></div><div id="exerciseWrapper"></div>';
		$('#form_exercise_chooser').html(tpl);
		//createExerciseLibraryChapter_copy(choosedExerciseLibraryChapter,exercises,null);

		layer.open({
			type: 1,
			title: '<img class="navTranImg" src="/Public/img/icon/t_zuoyexitong.png">',
			//			 '选择习题@' + $(obj).html(),
			shade: 0,
			zIndex: 20160922,
			content: $('#form_exercise_chooser').html(),
			area: ['100%', '100%'],
			closeBtn: 0,
			move: false
		});
		$('#form_exercise_chooser').html('');
		setTimeout("renderExerciseInALibrary(choosedExerciseLibraryChapter)", 500);
	}
</script>
<script>
	function notifyOnErrorInput(input) {
		var message = input.data('validateHint');
		$.Notify({
			caption: '提示',
			content: message,
			type: 'warning'
		});
	}

	var choosedHomeworkId = 0;

	function check() {

		if ($("#homework_name").val() == '') {
			return false;
		}
		if ($("#claim").val() == '') {

			return false;
		}
		if ($("#type_id").val() == '') {

			return false;
		}
		if ($("#grade_id").val() == '') {
			return false;
		}
		if ($("#class_id").val() == '') {
			return false;
		}
		if ($("#course_id").val() == '') {
			return false;
		}
		if ($("#textbook_id").val() == '') {
			return false;
		}

		var string = $('#form_selected_exercise').text();
		if (string == '') {
			alert('请选择题目');
			return false;
		}
		$('#exerciseList').val(string);

		//$("#Myform").attr('action',"{:U('Teach/assignHomework')}"+string);
		return true;
	}
</script>

<script>
	var selectedExercise = [];
	//渲染习题库里的每个习题
	function renderExerciseInALibrary(chapterId) {
		//ajax 获取章节内的小题
		renderExerciseLibraryChapter(chapterId, '', function (res) {
			$('#exerciseWrapper input,#exerciseWrapper textarea').remove(); //去掉了习题里的操作框（单选框、复选框、输入框），以免与习题的作答功能混在一起干扰教师选择小题
			//$('#exerciseWrapper .exerciseQuestion').prepend('<input type="checkbox" name="choose_exercise" onclick="onClick_SelectOneExerciseInALibrary(this)">');
			var choosed_ids = '';
			$('#exerciseWrapper .exerciseQuestion').each(function (i, n) {
				var checked = '';
				var exercise_id = $(n).attr('data-originalid');
				$.each(selectedExercise, function (j, m) {
					if (m.chapter_id == chapterId && m.exercise_id == exercise_id) {
						checked = 'checked';
						choosed_ids = choosed_ids + exercise_id + ',';
					}
				});
				$(n).prepend('<input type="checkbox" id="selectSingleExercises" name="choose_exercise" onclick="onClick_SelectOneExerciseInALibrary(this)" {0}>'.format(checked));
				//点赞图片
				$(n).append('<img class="collectImg" src="/Public/img/icon/collect1.png">');
			});
			
			//点赞换图  （不成功，，，）
			var favorCount = 0;
			$('.collectImg').click(function () {
				if (!canQuery()) {
					$.notify({
						title: '提示',
						message: '请求过于频繁'
					}, {
						type: 'success',
						placement: {
							from: "top",
							align: "center"
						}
					});
					return false;
				}
				favorCount++;
				$.get('__URL__/favorBjResource', {
					id: '{$data.id}'
				}, function (res) {
					if (res == 'success') {
						$(this).attr('src', '__PUBLIC__/img/icon/collect2.png');
						$.notify({
							title: '提示',
							message: '收藏成功'
						}, {
							type: 'success',
							placement: {
								from: "top",
								align: "center"
							}
						});
					} else {
						$(this).attr('src', '__PUBLIC__/img/icon/collect1.png');
						$.notify({
							title: '提示',
							message: res
						}, {
							type: 'warning',
							placement: {
								from: "top",
								align: "center"
							}
						});
					}
				});
			});
			
			$('#form_exercise_chooser_selected').html(choosed_ids);
		});
	}
	//选择小题的触发事件
	function onClick_SelectOneExerciseInALibrary(obj) {
		var ids = $('#form_exercise_chooser_selected').html();
		var currentId = $(obj).parent().attr('data-originalid');
		if (obj.checked) {
			if (ids.indexOf(currentId + ',') == -1) {
				ids = ids + currentId + ',';
			}
		} else {
			ids = ids.replace(currentId + ',', '');
			$('#selectAllExercises').removeAttr('checked');
		}

		if (ids != '' && ids[ids.length - 1] != ',') ids = ids + ',';
		$('#form_exercise_chooser_selected').html(ids);
	}
	//确定选择小题的事件
	function onClick_ConfirmTheSelectedExerciseInALibrary() {
		var newResult = [];
		$.each(selectedExercise, function (i, n) {
			if (n.chapter_id != choosedExerciseLibraryChapter) {
				newResult.push(n);
			}
		});
		var currentSelectedIds = $('#form_exercise_chooser_selected').text().split(',');
		$.each(currentSelectedIds, function (i, n) {
			if (n == '') return true;
			newResult.push({
				chapter_id: choosedExerciseLibraryChapter,
				exercise_id: n
			});
		});

		selectedExercise = newResult;
		renderSelectedExerciseInCreateHomework();
		$('.layui-layer-page').each(function (i, n) {
			var id = $(n).attr('id').replace('layui-layer', '');
			layer.close(id);
		});
	}
	//选择所有小题
	function onClick_SelectAllTheExerciseInALibrary(obj) {
		if (obj.checked) {
			$('#exerciseWrapper input').removeAttr('checked');
			$('#exerciseWrapper input').click();

		} else {
			$('#exerciseWrapper input').removeAttr('checked');
			$('#form_exercise_chooser_selected').html('');
		}
	}

	//渲染已经选择的习题列表
	function renderSelectedExerciseInCreateHomework() {
		var html = [];
		$.each(selectedExercise, function (i, n) {
			html.push(n.chapter_id + '.' + n.exercise_id);
		});
		$('#form_selected_exercise').html(html.join('; '));
	}
</script>

<script>
	$('.yesBtn').click(function(){
		$('.collectSuccess').hide();
	})
</script>