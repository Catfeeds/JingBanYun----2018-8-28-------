<layout name="teacher_layout_3" />
<script src="__PUBLIC__/js/exercise/sha1.js?" type="text/javascript"></script>
<link rel="stylesheet" href="__PUBLIC__/css/rotate.css">
<link rel="stylesheet" href="__PUBLIC__/css/voice.css" >
<script type="text/javascript" src="__PUBLIC__/js/voiceInput.js" ver=1>

</script>
<style>
	.form_section {
		margin-bottom: 12px;
	}

	.exerciseChapterWrapper {
		margin: 20px 0;
		padding: 8px;
		cursor: pointer;
		border: 1px solid #ccc;
	}

	.exerciseChapterWrapper.selected {
		background: green;
		color: #fff
	}

	.main_head {
		padding: 17px;
	}

	.copy_left {
		width: 35%;
		float: left;
		padding-right: 30px;
		border-right: 5px solid #e9e3cb;
		min-height: 600px
	}

	.copy_right {
		width: 65%;
		float: left;
		padding: 0 20px;
	}

	.btn_copy {
		color: #595757;
		background-color: #fff;
		border: 1px solid #E9C232;
		font-weight: 600;
	}

	.checkbox_choice {
		width: 20px;
		height: 20px;
	}

	.a-control {
		display: block;
		width: 100%;
		height: 34px;
		padding: 6px 12px;
		font-size: 14px;
		line-height: 1.428571429;
		color: #555555;
		background-color: white;
		background-image: none;
		border: 1px solid #cccccc;
		border-radius: 4px;
		-webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
		box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
		-webkit-transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		-o-transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		transition: border-color ease-in-out 0.15s, box-shadow ease-in-out 0.15s;
		text-decoration: none;
		margin-bottom: 10px;
	}

	#navThumImg1,
	#navThumImg3,
	#navThumImg5 {
		-moz-transform: rotate(20deg);
		-webkit-transform: rotate(20deg);
		transform: rotate(20deg);
	}

	#navThumImg2,
	#navThumImg4 {
		-moz-transform: rotate(-20deg);
		-webkit-transform: rotate(-20deg);
		transform: rotate(-20deg);
	}

	#navThumImg1:hover,
	#navThumImg3:hover,
	#navThumImg5:hover {
		-moz-animation: rotate_z 0.8s infinite ease;
		-webkit-animation: rotate_z 0.8s infinite ease;
		animation: rotate_z 0.8s infinite ease;
	}

	#navThumImg2:hover,
	#navThumImg4:hover {
		-moz-animation: rotate_f 0.8s infinite ease;
		-webkit-animation: rotate_f 0.8s infinite ease;
		animation: rotate_f 0.8s infinite ease;
	}

	@-moz-keyframes rotate_z {
		0% {
			-moz-transform: rotate(20deg);
		}
		100% {
			-moz-transform: rotate(360deg);
		}
	}

	@-webkit-keyframes rotate_z {
		0% {
			-webkit-transform: rotate(20deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}

	@keyframes rotate_z {
		0% {
			transform: rotate(20deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	@-moz-keyframes rotate_f {
		0% {
			-moz-transform: rotate(20deg);
		}
		100% {
			-moz-transform: rotate(360deg);
		}
	}

	@-webkit-keyframes rotate_f {
		0% {
			-webkit-transform: rotate(20deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}

	@keyframes rotate_f {
		0% {
			transform: rotate(20deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	#selectSingleExercises,
	#selectAllExercises {
		width: 20px;
		height: 20px;
	}

	.layui-layer-title {
		background: #E9C232;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px
	}

	.questionWrapper {
		margin-top: 80px;
		border: none;
	}

	#form_selected_exercise,#form_selected_exercise1 {
		word-break: break-all;
		display: none
	}
	textarea {
		resize: none;
	}

	.copy_right label {
		width: 30px;
		text-align: right;
	}

	.copy_right .form-control {
		display: inline-block;
		width: 80%;
	}

	.laydate_body .laydate_bottom, .laydate_body .laydate_top, .laydate_body .laydate_ym .laydate_yms {
        box-sizing: content-box;
    }

    .timeInput {
    	background: #fff url(http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/Icons/dateYellow.png) no-repeat 95% center !important;
	    cursor: inherit !important;
	    background-size: 22px auto !important;
    }

	.form_section label {
		position: relative;
	}

    .requiredSpan {
	    color: red;
	    font-size: 24px;
	    position: absolute;
	    right: -12px;
	    top: -2px;
    }
</style>

<div class="main_opr">
	<a href="{:U('TeachmulHomework/mulHomework')}" title="语音作业" class="btn btn-main-opr btn-main-opr-active">语音作业</a>
	<a href="{:U('Teach/homework')}" title="习题作业" class="btn btn-main-opr">习题作业</a>
	<a href="{:U('Teach/exercisesLibrary')}" title="习题库" class="btn btn-main-opr">习题库</a>
	<a href="{:U('Teach/wrongHomeworkList')}" title="错题集" class="btn btn-main-opr">错题集</a>
</div>

<div style="margin-bottom: 12px;">
	<a href="{:U('TeachmulHomework/mulHomework')}" title="返回" class="btn btnReturn3">返回</a>
</div>

<!-- <div class="main_head">
    <a href="{:U('Teach/homework')}" title="作业列表" class="btn btn-primary">作业列表</a>
    <a href="##" title="布置作业" class="btn btn-primary" style="background:#eac31c !important;">布置作业</a>
</div>-->

<form action="" id="formMul">
<div class="copy_left">

		<!--<input type="hidden" name="exerciseChapterId" id="exerciseChapterId">-->
		<input type="hidden" name="exercise_ids" id="exerciseList">
		<div class="form_section">
			<label for="homework_name">作业名称<span class="requiredSpan">*</span></label>

			<div class="input-control text full-size">
				<input type="text" name="homework_name" id="homework_name" class="form-control input-width" required>
			</div>
		</div>

		<div class="form_section" style="height: 100px">
			<label for="claim">作业要求<span class="requiredSpan">*</span></label>

			<div class="input-control text full-size">
				<textarea id="claim" name="claim" rows="3" class="form-control" required maxlength="50"></textarea>
			</div>
		</div>
		<br>
		<div class="form_section">
			<label for="type_id">作业类型<span class="requiredSpan">*</span></label>

			<div class="input-control text full-size">
				<select id="type_id" name="type_id" class="form-control" required>
					<option value="">-请选择-</option>
					<option value="1">课堂作业</option>
					<option value="2">课后作业</option>
				</select>
			</div>
		</div>

		<div class="form_section">
			<label for="class_id">选择班级<span class="requiredSpan">*</span></label>

			<div class="input-control text full-size">
				<select id="class_id" name="class_id" class="form-control" required>
					<option value="">-请选择-</option>
					<volist name="class_list" id="class_item">
						<option value="{$class_item.id}|{$class_item.grade_id}" >{$class_item.grade}{$class_item.name}</option>
					</volist>
				</select>
			</div>
		</div>

		<div class="form_section">
			<label for="arrangeTime">布置时间</label>

			<div class="input-control text full-size">
				<input type="text" name="arrangeTime" id="arrangeTime" class="form-control input-width timeInput" placeholder="默认为当前时间布置作业" onkeydown="false">
			</div>
		</div>

		<div class="form_section">
			<label for="endTime">截止时间<span class="requiredSpan">*</span></label>

			<div class="input-control text full-size">
				<input type="text" name="endTime" id="endTime" class="form-control input-width timeInput" required placeholder="请选择截止时间" onkeydown="false">
			</div>
		</div>

<!-- 		<div class="form-actions" style="text-align: center; ">
			<button type="submit" class="btn btn-primary" id="saveButton">保存</button>
		</div> -->
		<input type="hidden" class="setCodeList">
    <!-- </form> -->
</div>

<!-----------------习题库-------------------->
<!-----------------复制习题-------------------->
<div class="copy_right" id="copy_homework" style="display:none;">
	<div class="row" style="margin-bottom:50px;">
		<div class="col-md-2" style="font-size:16px;">
			<label for="all_choice">
				<input type="checkbox" name="all_choice" id="all_choice" class="checkbox_choice">&nbsp;全选</label>
		</div>
		<div class="col-md-8">
			<div style="display:none;" class="col_child">
				<span title="已选择习题" class="btn btn_copy">已选择习题</span>
				<!-------习题编号----------->
				<!--<span title="习题编号" class="btn btn_copy">1</span> -->
			</div>
		</div>
	</div>
	<!--------------------习题部分---------------------------->
	<div class="row">
		<!--
       <div class="col-md-1">
           <input type="checkbox" id="box_id" class="checkbox_choice">
       </div>
       -->
		<div class="col-md-11">
			<!---------------习题内容-------------->

		</div>
		<div id="form_exercise_chooser" style="display: none;"></div>
	</div>
</div>

<!-----------------添加习题-------------------->
<div class="copy_right" id="add_homework">
	<div style="display:inline-block;margin-bottom:20px">已选择习题总数：<span id="form_selected_exercise">{$exercise_list}</span><span id="form_selected_exercise1">{$exercise_list}</span><span id="form_selected_exercise2">{$exercise_list}</span></div>
	<div class="right">
		<button type="button" class="btn btn-primary " id="previewButton"  onclick="preview()" style="display:none">已选试题预览</button>
		<button type="submit" class="btn btn-primary " id="saveButton" >保存</button>
		<button type="button" class="btn btn-primary " id="resetButton"  onclick="resave()" style="display:none">清空已选试题</button>
	</div>


	<!-- </div> -->
	<!-- <form action="" method="post"  style="margin: 0 !important;"> -->
		<div class="row" style="margin-bottom:10px;">
			<div class="col-md-4">
				<label for="course_id">学科</label>
				<select id="courseId" name="courseId" class="form-control" required onchange="getcharp()">
					<option value="">-请选择-</option>
					<volist name="courseList" id="courseList" empty="">
						<option value="{$courseList.id}">{$courseList.name}</option>
					</volist>
				</select>
			</div>
			<div class="col-md-4">
				<label for="grade_id">年级</label>
				<select id="grade" name="grade" class="form-control" required onchange="getcharp()">
					<option value="">-请选择-</option>
					<volist name="grade" id="gradeList" empty="">
						<option value="{$gradeList.id}">{$gradeList.grade}</option>
					</volist>
				</select>
			</div>
			<div class="col-md-4">
				<label for="textbook_id">分册</label>
				<select id="volume" name="volume" required="" class="form-control" onchange="getcharp()">
					<option value="0">请选择</option>
					<option value="1">上册</option>
					<option value="2">下册</option>
					<option value="3">全一册</option>
				</select>
			</div>
		</div>
		<div class="row" style="margin-bottom:50px;">
			<div class="col-md-4">
				<label for="chapter">章</label>
				<select name="" id="chapter" class="form-control" onchange="getChildcharp()">
					<option value="0">请选择</option>
				</select>
			</div>
			<div class="col-md-4">
				<label for="section">节</label>
				<select name="" id="section" class="form-control" onchange="jie()" >
					<option value="0">-请选择-</option>
				</select>
			</div>

		</div>

	<!--------------------章节部分---------------------------->
	<div class="from_after">

	</div>
	<div class="previewDiv " style="display:none">
		<div>
			<button class="sub_opr btnReturn3 layer-open layui-layer-close" style="margin: 30px;border-radius:8px;font-size:16px;position: initial;">返回
			</button>
		</div>
		<div class="previewDivContent">

		</div>
	</div>
</div>
</form>

<script type="text/javascript" src="__PUBLIC__/js/layer/layer.js"></script>
<script src="__PUBLIC__/laydate/laydate.js"></script>
<script>
    !function(){
        laydate.skin('huang');//切换皮肤，请查看skins下面皮肤库
    }();

    //布置时间
    var timeArrange = {
        elem: '#arrangeTime',
        format: 'YYYY-MM-DD hh:mm',
        min: laydate.now(), //设定最小日期为当前日期
        max: '2099-06-16', //最大日期
        istime: true,
        istoday: false,
        choose: function(datas){
            timeEnd.min = datas; //开始日选好后，重置结束日的最小日期
            timeEnd.start = datas; //将结束日的初始值设定为开始日
        }
    };

    //截止时间
    var timeEnd = {
        elem: '#endTime',
        format: 'YYYY-MM-DD hh:mm',
        min: laydate.now(), //设定最小日期为当前日期
        max: '2099-06-16', //最大日期
        istime: true,
        istoday: false,
        choose: function(datas){
            timeArrange.max = datas; //结束日选好后，充值开始日的最大日期
			timeArrange.max = datas;
        }
    };
    laydate(timeArrange);
    laydate(timeEnd);
</script>

<script>
	function getcharp(){
		var version_id = 1;
		var courseId = $('#courseId').val();
		var grade_id = $('#grade').val();
		var school_term = $('#volume').val();//分册

		$("#chapter option:not(:eq(0))").remove();
		$("#section option:not(:eq(0))").remove();

		$.ajax({
			type: 'POST',
			url: '/index.php?m=Home&c=TeachmulHomework&a=getNextLevelKnowledge',
			cache: false,
			data:{'version':version_id,'courseId':courseId,'grade_id':grade_id,'school_term':school_term,'level':1},
			// async: false,
			dataType:'json',
			success: function(msg){
				if(msg.status == 200){
					if(msg.data.length){
						var html = '';
						var	option =  "<option value='{0}'>{1}</option>";
						html += option.format(0,'请选择');
						$(msg.data).each(function (i, n) {

							html += option.format(n.id, n.tree_point_name);

							$('#chapter').html(html);
						})
					}
				}
			}
		})
	}

	String.prototype.format = function (args) {
		var result = this;
		if (arguments.length > 0) {
			if (arguments.length == 1 && typeof (args) == "object") {
				for (var key in args) {
					if (args[key] != undefined) {
						var reg = new RegExp("({" + key + "})", "g");
						result = result.replace(reg, args[key]);
					}
				}
			} else {
				for (var i = 0; i < arguments.length; i++) {
					if (arguments[i] != undefined) {
						var reg = new RegExp("({)" + i + "(})", "g");
						result = result.replace(reg, arguments[i]);
					}
				}
			}
		}
		return result;
	}

	function getChildcharp(){
		var id = $('#chapter').val();
		$('.from_after').html('');
		$('.from_after').hide();

		$("#section option:not(:eq(0))").remove();
		$.ajax({
			type: 'POST',
			url: '/index.php?m=Home&c=TeachmulHomework&a=getNextLevelKnowledge',
			cache: false,
			data:{'id':id,'level':2},
			// async: false,
			dataType:'json',
			success: function(msg){
				if(msg.status == 200){
					if(msg.data.length){
						var html = '';
						var	option =  "<option value='{0}'>{1}</option>";
						html += option.format(0,'请选择');
						$(msg.data).each(function (i, n) {
							html += option.format(n.id, n.tree_point_name);
							$('#section').html(html);
						})
					}
				}
			}
		})
	}

	function jie() {
		var ch_name = $("#chapter option:selected").text();
		var section_name = $("#section option:selected").text();
		$('.from_after').html('');
		$('.from_after').show();
		var section_id = $("#section").val();

		if (ch_name!='' && section_name!='' && section_name!='请选择' && ch_name!='请选择' ) {
			$('.from_after').html('<a href="javascript:" class="a-control" section_id="'+section_id+'" onclick="actionClick(this)">'+ch_name+' '+section_name+' （点击预览习题）</a>');
		}
	}

    $(document).ready(function(){
        $("#formMul").submit(function(e){
			$('#saveButton').attr('disabled','disabled');
            e.preventDefault();
            var homework_name = $('#homework_name').val();
            var jobsments = $('#claim').val();//要求
            var type = $('#type_id').val();//类别
            var class_id = $('#class_id').val();

            var courseId = $('#courseId').val();
            var grade = $('#grade').val();
            var volume = $('#volume').val();
            var chapter = $('#chapter').val();
            var section = $('#section').val();

            var course_name = $("#courseId").find("option:selected").text();
            var grade_name = $("#grade").find("option:selected").text();
            var volume_name = $("#volume").find("option:selected").text();
            var chapter_name = $("#chapter").find("option:selected").text();
            var section_name = $("#section").find("option:selected").text();
            var form_selected_exercise = $('#form_selected_exercise').text();

			var arrangeTime = $('#arrangeTime').val();

			var endTime = $('#endTime').val();

			if ($('#form_selected_exercise1').text() ==''){
				$.NotifyBox.NotifyPromptOne('提示','请选择习题','确定');
				$('#saveButton').removeAttr('disabled');
				return false;
			}
            var dataList={homework_name:homework_name,jobsments:jobsments,type:type,class_id:class_id,courseId:courseId,grade:grade,volume:volume,chapter:chapter,section:section,course_name:course_name,grade_name:grade_name,volume_name:volume_name,chapter_name:chapter_name,section_name:section_name,form_selected_exercise:form_selected_exercise,arrangeTime:arrangeTime,endTime:endTime,selectedChapterExercise:selectedChapterExercise};

            $.ajax({
                type: 'POST',
                url: '/index.php?m=Home&c=TeachmulHomework&a=mulAssignHomework',
                cache: false,
                data:dataList,
                // async: false,
                dataType:'json',
                success: function(msg){
                    if(msg.code == 200){
                        window.location.href="/index.php?m=Home&c=TeachmulHomework&a=mulHomework"
                    } else {
						$('#saveButton').removeAttr('disabled');
						$.NotifyBox.NotifyPromptOne('提示',msg.msg,'确定')
                    }
                }
            })

        });
    });
	function actionClick(obj) {
	global_div = 1; 
	objId = $(obj).attr('section_id');
	$('#create_outclass_homework .exerciseChapterWrapper').removeClass('selected');
	$(obj).addClass('selected');
	choosedExerciseLibraryChapter = $('#courseId').val()+','+$('#grade').val()+','+$('#volume').val()+','+$('#chapter').val()+','+$(obj).attr('section_id');
	var tpl = '<div style="font-size: 18px;position: fixed;z-index:9999;left: 0;top:23px;width: 98%;margin-top:-3px;background:#fff"><div><button class="sub_opr btnReturn3 layer-open layui-layer-close" style="margin: 30px;border-radius:8px;font-size:16px;position: initial;">返回</button></div><div  class="exerciseChoose"> 选择习题@ ' + $(obj).html() + '</div><div class="allChoose" style="width: 220px;float:left;background:#fff"><label><input id="selectAllExercises" onclick="onClick_SelectAllTheExerciseInALibrary(this)" type="checkbox">全选</label>&nbsp;&nbsp;已选择习题数量：</div><div style="width:60%;float:left;background:#fff"><span id="form_exercise_chooser_selected2" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px;"></span><span id="form_exercise_chooser_selected" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px;display:none"></span><span id="form_exercise_chooser_selected1" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px; display:none"></span></div>&nbsp;&nbsp;<div style="width:70px;float:right;" class="querenBtn"><button class="sub_opr btn3before" style="float: right;margin: 0 15px 0 0;width:72px;border-radius:8px;font-size:16px;letter-spacing:0;" onclick="onClick_ConfirmTheSelectedExerciseInALibrary();">确&nbsp;认</button></div></div><div id="exerciseWrapper_1" style="margin-top: 195px"></div>';
	$('#form_exercise_chooser').html(tpl);
	layer.open({
		type: 1,

		shade: 0,
		zIndex: 20160922,
		content: $('#form_exercise_chooser').html(),
		area: ['100%', '100%'],
		closeBtn: 0,
		move: false,
		scrollbar: false,
	});
	$('#form_exercise_chooser').html('');

	$.ajax({
		type:'GET',
		url:'index.php?m=Home&c=TeachmulHomework&a=getExerciseList&section_id='+objId,

		dataType: 'json',
		success:function(res){
			// console.log(res);
			var form_selected_exercise = $('#form_selected_exercise').text()
			var arrayList = {};
			voice(res,'#exerciseWrapper_1','checkbox', form_selected_exercise,arrayList);

		}
	})
}
</script>
<script>
	function preview(){
		var arrayList = {};
		for(var i in selectedChapterExercise){
			if (selectedChapterExercise.hasOwnProperty(i)) { //filter,只输出man的私有属性
				console.log(i);
				console.log(selectedChapterExercise[i]);
				for (var j=0;j<selectedChapterExercise[i].length;j++) {
					console.log(selectedChapterExercise[i][j]['exercise_id']);
					arrayList[selectedChapterExercise[i][j]['exercise_id']] = i;
				}
			};
		}
		console.log(arrayList);
		var form_selected_exercise = $('#form_selected_exercise').text()
		var tpl = '<div style="font-size: 18px;position: fixed;z-index:9999;left: 0;top:23px;width: 98%;margin-top:-3px;background:#fff"><div><button class="sub_opr btnReturn3 layer-open layui-layer-close" style="margin: 30px;border-radius:8px;font-size:16px;position: initial;">返回</button></div><div class="allChoose" style="width: 220px;float:left;background:#fff"><label><input id="selectAllExercises" onclick="onClick_SelectAllTheExerciseInALibrary(this)" type="checkbox">全选</label>&nbsp;&nbsp;已选择习题数量：</div><div style="width:60%;float:left;background:#fff"><span id="form_exercise_chooser_selected2" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px;"></span><span id="form_exercise_chooser_selected" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px;display:none"></span><span id="form_exercise_chooser_selected1" style="font-size: 18px;color: #EAC41B;word-break: break-all;line-height:36px; display:none"></span></div>&nbsp;&nbsp;<div style="width:70px;float:right;" class="querenBtn"><button class="sub_opr btn3before" style="float: right;margin: 0 15px 0 0;width:72px;border-radius:8px;font-size:16px;letter-spacing:0;" onclick="onClick_ConfirmTheSelectedExerciseInALibrary1();">保&nbsp;存</button></div></div><div id="exerciseWrapper_1" style="margin-top: 140px"></div>';
		$('#form_exercise_chooser').html(tpl);
		layer.open({
			type: 1,

			shade: 0,
			zIndex: 20160922,
			content: $('#form_exercise_chooser').html(),
			area: ['100%', '100%'],
			closeBtn: 0,
			move: false,
			scrollbar: false,
		});
		$('#form_exercise_chooser').html('');
		$.ajax({
			type:'post',
			url:'index.php?m=Home&c=TeachmulHomework&a=getExerciseIdList',
			data:{
				exerciseId:form_selected_exercise
			},
			dataType: 'json',
			success:function(res){

				voice(res,'#exerciseWrapper_1','checkbox', form_selected_exercise,arrayList);
			}
		})

	}
	function notifyOnErrorInput(input) {
		var message = input.data('validateHint');
		$.Notify({
			caption: '提示',
			content: message,
			type: 'warning'
		});
	}
</script>
