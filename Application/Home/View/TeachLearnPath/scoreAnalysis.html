<layout name="teacher_layout_3" />

<link rel="stylesheet" href="__PUBLIC__/css/learnPathList.css">
<link href="__PUBLIC__/css/jquery.ui.datepicker.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="__PUBLIC__/js/external/highcharts.js"></script>
<script src="__PUBLIC__/js/highcharts-exporting.js"></script>
<script src="__PUBLIC__/js/external/grid-light.js"></script>
<!--错题总结-->
<script src="__PUBLIC__/js/exercise/sha1.js?" type="text/javascript"></script>
<script src="__PUBLIC__/js/exercise/render_1.js?" type="text/javascript"></script>
<script src='__PUBLIC__/js/external/polyvplayer.min.js'></script>
<link type="text/css" rel="stylesheet" href="__PUBLIC__/umeditor/third-party/mathquill/mathquill.css"/>
<script type="text/javascript" src="__PUBLIC__/umeditor/third-party/mathquill/mathquill.js"></script>
<link href="__PUBLIC_THEME__/stylesheets/exercise.css?v=2" rel="stylesheet" type="text/css"/>

<style>
    .filterTable {
        width: 100%;
        border: 1px solid #000;
        border-radius: 10px;
    }
    
    .filterTable td {
        text-align: center;
        width: 20%;
        padding: 0px;
    }
    
    .filterTable_item.selected {
        background-color: #41C7DB;
        ;
    }
    
    .filterTable_item {
        position: relative;
        cursor: pointer;
        height: 30px;
    }
    
    .filter_unit {
        line-height: 30px;
        font-size: 18px;
    }
    
    .filter_show {
        position: absolute;
        z-index: 200;
        left: 0;
        top: 30px;
        border: 1px solid #000;
        width: 200px;
        background-color: #fff;
        display: none;
        padding: 4px;
    }
    
    .filter_show input {
        width: 100%;
    }
    
    .filter_show_section {
        margin: 12px 0;
    }
    
    .filterTable_item img {
        height: 26px;
        position: absolute;
        z-index: 200;
        right: 3px;
        top: 3px;
    }
    
    #filter_day,
    #filter_month {
        height: 26px;
    }
	
	.laydate_body .laydate_bottom, .laydate_body .laydate_top, .laydate_body .laydate_ym .laydate_yms {
		box-sizing: content-box;
	}
	
	.qq-uploader {
		max-height: 540px
	}
	
	#laydate_hms {
		display: none !important
	}
	.questionLeft p{
		display: inline-block;
	}
	.h400{
		height: 400px;
	}
	.mt117{
		margin-top:117px;
	}
	.table_cj{
		display: none;
	}

    .table_cj img{
        max-width: 100%
    }
</style>
<div style="margin-bottom: 12px;">
    <a href="javascript:history.go(-1)" title="返回" class="btn btnReturn3">返回</a>
</div>
<!--关联的学生-->
<div class="studentOutter">
	<span class="title">学生姓名：{$student.student_name}</span>
	

</div>
<hr>
<div class="oh">
    <div class="left">
        <select id="course_id" name="course_id" class="form-control">
            <option value="">所有学科轨迹</option>
            <volist name="courses" id="dataCourse">
                <option value="{$dataCourse.id}">
                    {$dataCourse.name}学科轨迹
                </option>
            </volist>
        </select>
    </div>
	
    <div class="timeOutter">
    	<span class="startBox">
    		<label for="startTime" class="startLabel"></label>
    		<input type="text" class="timeInput" name='' id="startTime" placeholder="请选择开始日期" onkeydown="return false">
    	</span>
    	<span class="endBox">
    		<label for="endTime" class="endLabel"></label>
    		<input type="text" class="timeInput" name='' id="endTime" placeholder="请选择结束日期" onkeydown="return false"  >
    	</span>
    	<button type="submit" class="searchTime" onclick="return searchTime()"></button>
	</div>
</div>

<div id="chart">
	<div class="text-center h400 table_cj_jiazai" >
		<img src="__PUBLIC__/img/learningPath/nulijiazai.png" class="mt117">
	</div>
</div>

<div class="text-center table_cj h400" >
	<img src="__PUBLIC__/img/learningPath/zanwushuju.png">
</div>

<!---------------错题总结-------------->
<div class="wrongTitle">错题总结</div>
<div id="exerciseWrapper" class="exerciseOutter">
	<!--收藏的题-->
	<volist name="errorwork" id="errordata" key="k" empty="">
		<div class="questionOutter">
			<div class="questionLeft">
				<a href="{:U('TeachLearnPath/homeworkExercises?id=')}{$errordata.homework_id}&studentId={$studentId}">{$errordata.homework}</a>
			</div>
		</div>
	</volist>

    <!--未收藏的题-->
    <!--<div class="questionOutter">
    	<div class="questionLeft">
    		2.我是第二题。
    	</div>
    	<img class="collectImg collImg" onclick="collectExercise(this)" src="/Public/img/icon/collect1.png">
    </div>-->
</div>


<script src="__PUBLIC__/laydate/laydate.js"></script>
<link href="__PUBLIC__/css/jquery.ui.datepicker.css" rel="stylesheet" type="text/css" />
<script>
    Date.prototype.Format = function (fmt) { //author: meizz 
        var o = {
            "M+": this.getMonth() + 1, //月份 
            "d+": this.getDate(), //日 
            "h+": this.getHours(), //小时 
            "m+": this.getMinutes(), //分 
            "s+": this.getSeconds(), //秒 
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
            "S": this.getMilliseconds() //毫秒 
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }
    
    var studentId = '{$student.id}';
	var class_id = '{$class_id}';
    var scoresDetails = [];
    var startDate = '',
        endDate = '',
        courseId = '';
    var startDateStr = '',
        endDateStr = '';
    var xAxisArr = [];
    var yAxisArr = [];
    var homeworkIdArr = [];
    getHomeworkScoreByStudentId();

    function getHomeworkScoreByStudentId() {
        xAxisArr = [];
        yAxisArr = [];
        homeworkIdArr = [];
        $.get('index.php?m=Home&c=TeachLearnPath&a=getHomeworkScoreByStudentId', {
                student_id: studentId,
				class_id: class_id,
                startDate: startDate,
                endDate: endDate,
                course: courseId
            },
            function (res) {

				if (res == '') {
					$('#chart').hide();
					$('.table_cj_jiazai').hide();
					$('.table_cj').show();

				} else {
					$('#chart').show();
					$('.table_cj').hide();
					scoresDetails = res;
					do_tj();
				}
            });

    }
    $('#fullscreen_ctrl,#escfullscreen_ctrl').click(function(){
        getHomeworkScoreByStudentId();
    });
    function do_tj() {
        var studentNameArr = [];
        $(scoresDetails).each(function (i, n) {
            if ($.inArray(n.homework_id, homeworkIdArr) == -1) {
                xAxisArr.push(n.homework_name);
                homeworkIdArr.push(n.homework_id);
            }
            var studentName = n.student_name;
            if ($.inArray(studentName, studentNameArr) == -1) {
                studentNameArr.push(studentName);
            }
        });

        function series(name, length) {
            this.name = name;
            this.data = new Array(length);

        }

        var seriesArray = new Array(studentNameArr.length);
        $(seriesArray).each(function (i, n) {
            seriesArray[i] = new series(studentNameArr[i], homeworkIdArr.length);
            $(seriesArray[i].data).each(function (index, nouse) {
                seriesArray[i].data[index] = null;
            });
        });
        $(scoresDetails).each(function (i, n) {
            var studentName = n.student_name;
            $(studentNameArr).each(function (iName, SName) {
                if (SName == studentName)
                    seriesArray[iName].data[$.inArray(n.homework_id, homeworkIdArr)] = parseInt(n.points);
            });
        });
        $(seriesArray).each(function (i, n) {
            yAxisArr.push(n);
        });
        var dateString = (startDateStr == endDateStr)?startDateStr:startDateStr + '~' + endDateStr;
        $('#chart').highcharts({
			plotOptions: {
				series: {
					cursor: 'pointer',
					events: {
						click: function(e) {

						}
					}
				}
			},
            credits: {
                text: '',
                href: 'http://www.jingbanyun.com'
            },
            title: {
                text: dateString + '{$student.student_name}学习成绩轨迹图' + (scoresDetails.length == 0 ? '（没有数据）' : ''),
                x: -20 //center
            },
            xAxis: {
                title: {
                    text: '作 业 名 称',
					style: {
						color: '#333',
						fontWeight: 'bold'
					},
					margin: 20
                },
                categories: xAxisArr,
				labels: {
					style: {
						color: '#333'
					}
				}
            },
            yAxis: {
                title: {
                    text: '成 绩',
					style: {
						color: '#333',
						fontWeight: 'bold'
					},
					margin: 20,
					rotation: 0
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }],
				labels: {
					style: {
						color: '#333'
					}
				}
            },
            tooltip: {
                valueSuffix: '分'
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle',
                borderWidth: 0
            },
            series: yAxisArr
        });
        $(window).resize();
    }
</script>
<script>
    $(function () {
        $('.filterTable_item').click(function () {
            $('.filterTable_item').removeClass('selected');
            var target = $(this).attr('data-id');
            $('.filter_show').hide();
            $('#filter_show_' + target).show();
            $(this).addClass('selected');
            event.stopPropagation();
        });
        $('#contentWrapper').bind('click', function () {
            $('.filter_show').hide();
        });

        $('#course_id').change(function () {
            courseId = $(this).val();
            getHomeworkScoreByStudentId();
        });

    });

    function filterTongji(type) {
        window.setTimeout(function () {
            $('.filter_show').hide();
        }, 200);

        switch (type) {
        case 'day':
            var day = $('#filter_day').val();
            if (day == '') {
                break;
            }
            startDate = day + ' 00:00:00';
            endDate = day + ' 23:59:59';
            break;
        case 'week':
            var getDaysByWeek = function (year, index) {
                var d = new Date(year, 0, 1);
                while (d.getDay() != 1) {
                    d.setDate(d.getDate() + 1);
                }
                var to = new Date(year + 1, 0, 1);
                var i = 1;
                var arr = [];
                for (var from = d; from < to;) {
                    if (i == index) {
                        arr.push(from.getFullYear() + "-" + (from.getMonth() + 1) + "-" + from.getDate());
                    }
                    var j = 6;
                    while (j > 0) {
                        from.setDate(from.getDate() + 1);
                        if (i == index) {
                            arr.push(from.getFullYear() + "-" + (from.getMonth() + 1) + "-" + from.getDate());
                        }
                        j--;
                    }
                    if (i == index) {
                        return arr;
                    }
                    from.setDate(from.getDate() + 1);
                    i++;
                }
            }
            var week = $('#filter_week').val();
            var year = parseInt(week.split('-')[0]);
            var week = parseInt(week.split('-')[1].replace('W', ''));
            var arr = getDaysByWeek(year, week);
            startDate = arr[0] + ' 00:00:00';
            endDate = arr[6] + ' 23:59:59';
            break;
        case 'month':
            var filter_month = $('#filter_month').val();
            var year = parseInt(filter_month.split('-')[0]);
            var month = parseInt(filter_month.split('-')[1]);
            var lastDay = getLastDayInMonth(year, month);
            startDate = filter_month + '-01 00:00:00';
            endDate = filter_month + '-' + lastDay + ' 23:59:59';
            break;
        case 'term':
            var filter_term = $('#filter_term').val();
            startDate = filter_term.split('~')[0] + '-01 00:00:00';
            var filter_term_2 = filter_term.split('~')[0]
            var year = parseInt(filter_term_2.split('-')[0]);
            var month = parseInt(filter_term_2.split('-')[1]);
            var lastDay = getLastDayInMonth(year, month);
            endDate = filter_term.split('~')[1] + '-' + lastDay + ' 23:59:59';
            break;
        case 'year':
            var filter_term = $('#filter_year').val();
            startDate = filter_term.split('~')[0] + '-01 00:00:00';
            var filter_term_2 = filter_term.split('~')[0]
            var year = parseInt(filter_term_2.split('-')[0]);
            var month = parseInt(filter_term_2.split('-')[1]);
            var lastDay = getLastDayInMonth(year, month);
            endDate = filter_term.split('~')[1] + '-' + lastDay + ' 23:59:59';
            break;
        }

        if (startDate == '' || endDate == '') {
            return;
        }
        startDateStr = startDate.substring(0, startDate.indexOf(' '));
        endDateStr = endDate.substring(0, endDate.indexOf(' '));
        startDate = new Date(startDate).getTime().toString();
        endDate = new Date(endDate).getTime().toString();
        startDate = startDate.substring(0, startDate.length - 3);
        endDate = endDate.substring(0, endDate.length - 3);
        getHomeworkScoreByStudentId();
        
        
    }

    //月份里的最后一天
    function getLastDayInMonth(year, month) {
        var new_year = year;
        var new_month = month++;
        if (month > 12) {
            new_month -= 12;
            new_year++;
        }
        var new_date = new Date(new_year, new_month, 1);
        return (new Date(new_date.getTime() - 1000 * 60 * 60 * 24)).getDate();
    }
    
    
    var before_val=$("#filter_year").val();
        var before_text=$("#filter_year").find('option:selected').text();
        
        //filter_year
        var date1 = new Date().Format("yyyy-MM"); 
        $("#filter_year").change(function(){
            var before_date=$("#filter_year").val(); 
            var before_date_text=$("#filter_year").find('option:selected').text();
            
            var temp_start_date=before_date.split('~');
            temp_start_date=temp_start_date[0];         console.log(temp_start_date);   console.log(date1);
            if(date1<temp_start_date){      
                $("#filter_year").val(before_val); 
                $("#filter_year").find('option:selected').text(before_text);
            } else{
                before_val=before_date;
                before_text=before_date_text; 
            } 
        });
        
        var before_term_val=$("#filter_term").val();
        var before_term_text=$("#filter_term").find('option:selected').text();
        $("#filter_term").change(function(){
            var before_term_date=$("#filter_term").val();
            var before_term_date_text=$("#filter_term").find('option:selected').text();
            
            var temp_start_date=before_term_date.split('~');
            temp_start_date=temp_start_date[0];     
            if(date1<temp_start_date){   
                $("#filter_term").val(before_term_val); 
                $("#filter_term").find('option:selected').text(before_term_text);
            }else{ 
                before_term_val=before_term_date;
                before_term_text=before_term_date_text;
            } 
        });
</script>


<!--20170509新增加-->
<script>
	//选择学生
	$('.studentBox').click(function(){
		$(this).addClass('active').siblings('.studentBox').removeClass('active')
	})
</script>

<!--开始时间 结束时间-->
<script>
	!function(){
		laydate.skin('yalan');//切换皮肤，请查看skins下面皮肤库
	}();

	//活动起始时间
	var actstart = {
		elem: '#startTime',
		format: 'YYYY-MM-DD',
//		min: laydate.now(), //设定最小日期为当前日期
		max: '2099-06-16', //最大日期
		istime: true,
		istoday: false,
		choose: function(datas){
			 actend.min = datas; //开始日选好后，重置结束日的最小日期
			 actend.start = datas; //将结束日的初始值设定为开始日
			time('#startTime')
		}
	};

	var actend = {
		elem: '#endTime',
		format: 'YYYY-MM-DD',
//		min: laydate.now(),
		max: '2099-06-16',
		istime: true,
		istoday: false,
		choose: function(datas){
			actstart.max = datas; //结束日选好后，充值开始日的最大日期
			time('#endTime')
		}
	};
	laydate(actstart);
	laydate(actend);
</script>

<script>
	var startLeft;
	$('#startTime').click(function(){
		startLeft = $('#laydate_box').css('left');
	})
	var a = 0;
	function time(id_){
		if($(id_).val() != '') {
			$(id_).siblings('label').addClass('yellow')
		} else {
			$(id_).siblings('label').removeClass('yellow')
		}
		$('#laydate_clear').click(function(){
			if($('#laydate_box').css('left') == startLeft) {
				$('#startTime').siblings('label').removeClass('yellow');
			} else {
				$('#endTime').siblings('label').removeClass('yellow')
			}
		})
	}
</script>

<script>
	function searchTime() {
		var startDatecopy = $('#startTime').val();
		var endDateStr = $('#endTime').val();

		$('#startTime').siblings('label').removeClass('yellow');
		$('#endTime').siblings('label').removeClass('yellow');

		startDate = startDatecopy;
		endDate = endDateStr;

		getHomeworkScoreByStudentId();

	}
</script>

<!--错题总结-->





