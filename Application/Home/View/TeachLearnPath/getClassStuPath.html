<link href="__PUBLIC__/css/layout.css" rel="stylesheet">
<link href="__PUBLIC_METRO__/css/metro-notify.css" rel="stylesheet">
<link href="__PUBLIC_THEME__/stylesheets/application-a07755f5.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC_THEME__/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="__PUBLIC__/Iconfont/iconfont.css">
<link rel="stylesheet" href="__PUBLIC__/css/homeList3.css?">
<link href="__PUBLIC__/infoPerfect/infoPerfect.css?v=1" rel="stylesheet" type="text/css"/>

<link href="__PUBLIC_METRO__/css/app/table_list3.css?v=2.0" type="text/css" rel="stylesheet">
<link href="__PUBLIC__/css/learnPathList.css" type="text/css" rel="stylesheet">

<style>
    body{
        display: block;
    }
    #contentWrapper {
        overflow-x: hidden;
    }

    .item {
        position: relative;
        display: inline-block;
        width: 300px;
        /*        height: 300px;*/
        height: 320px;
        float: left;
        margin: 0px 40px;
    }
    .h400{
        height: 400px;
    }
    .mt117{
        margin-top:117px;
    }
    .table_cj{
        display: none;
    }

    .table_cj img{
        max-width: 100%
    }

</style>
<style>

</style>

<empty name="list">
    <div class="emptyResult">
        <img src="__PUBLIC__/img/learningPath/shangweiyouxueshengjiaru.png" class="mt117">
    </div>
</empty>
<notempty name="list">

    <div class="left">
        <select id="course_id" name="course_id" class="form-control">
            <option value="">所有学科轨迹</option>
            <volist name="courses" id="dataCourse">
                <option value="{$dataCourse.id}">
                    {$dataCourse.name}
                </option>
            </volist>
        </select>
    </div>

    <div class="timeOutter">
    	<span class="startBox">
    		<label for="startTime" class="startLabel"></label>
    		<input type="text" class="timeInput" name='' id="startTime" placeholder="请选择开始日期" onkeydown="return false">
    	</span>
        <span class="endBox">
    		<label for="endTime" class="endLabel"></label>
    		<input type="text" class="timeInput" name='' id="endTime" placeholder="请选择结束日期" onkeydown="return false"  >
    	</span>
        <button type="submit" class="searchTime" onclick="return searchTime()"></button>
    </div>

    <div id="chart">
        <div class="text-center h400 table_cj_jiazai" >
            <img src="__PUBLIC__/img/learningPath/nulijiazai.png" class="mt117">
        </div>
    </div>

    <div class="text-center table_cj h400" >
        <img src="__PUBLIC__/img/learningPath/zanwushuju.png">
    </div>

    <div class="stu_zongshu mb20">
        学生总数{$student_count}人
    </div>


    <div id="grid_wrapper" class="showtype_wrapper row">
        <volist name="list" id="data" empty="">
            <div class=" student_grid col-lg-3 col-md-4 col-sm-6 student_list ">
                <?php if (preg_match('/Resources/', $data['avatar'])): ?>
                <img class="avatar" src="<?php echo C('oss_path').$data['avatar'] ?>">
                <?php else: ?>
                <?php if ( $data['sex']=='男' ): ?>
                <img class="avatar" src="__PUBLIC__/img/classManage/student_m.png">
                <?php else: ?>
                <img class="avatar" src="__PUBLIC__/img/classManage/student_w.png">
                <?php endif; ?>
                <?php endif; ?>

                <span class="info_link ml20">{$data.student_name}</span>
                <br>

                <span class="title_content mt10 ml20" title="{$data.id_card}">{$data.sex}</span>
                <br>

                <p class="info_title mt10">家长手机号：</span><span title="{$data.parent_tel}">{$data.parent_tel}</p>
                <p class="info_title m0 mb10">邮&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;箱：</span><span  title="{$data.user_name}">{$data.email}</p>
                <div  class="info_ctrl text-center">
                    <a  href="{:U('TeachLearnPath/scoreAnalysis?id=')}{$data.student_id}&classId={$classId}" target="_parent" title="活动表现" class="btn btn-primary-active mr10" >成绩分析</a>
                    <a class="btn btn-primary-active bang"></a>
                    <a href="{:U('TeachLearnPath/teacherMessage?student_id=')}{$data.student_id}&classId={$classId}" target="_parent" title="错题集" class="btn btn-primary-active ml10" >教师寄语</a>
                </div>

            </div>

        </volist>
    </div>
</notempty>

<script src="__PUBLIC__/js/external/jquery.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/common.js?v=4.0" type="text/javascript"></script>
<script src="__PUBLIC__/js/jQueryRotateCompressed.js?v=1.0" type="text/javascript"></script>
<script src="__PUBLIC_METRO__/js/metro.js"></script>

<script type="text/javascript" src="__PUBLIC__/js/external/highcharts.js"></script>
<script src="__PUBLIC__/js/highcharts-exporting.js"></script>
<script src="__PUBLIC__/js/external/grid-light.js"></script>

<script src="__PUBLIC__/js/external/jquery-ui-1.10.1.min.js" type="text/javascript"></script>
<!--<script src="__PUBLIC__/js/external/modernizr.min.js" type="text/javascript"></script>-->
<script src="__PUBLIC__/js/modernizr.min.js" type="text/javascript"></script>
<script src="__PUBLIC_THEME__/javascripts/application-985b892b.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/bootstrap-notify.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/exercise/render.js?v=3" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/js/FullScreen.js"></script>
<script src="__PUBLIC__/js/layout.js?v=5" type="text/javascript"></script>
<script src="__PUBLIC__/js/message/messageList.js"></script>
<script src="__PUBLIC__/laydate/laydate.js"></script>

<!--[if lt IE 9]>
<script src="__PUBLIC__/js/external/html5shiv.min.js"></script>
<script src="__PUBLIC__/js/external/respond.min.js"></script>


<![endif]-->


<script>
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "h+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    var classId = '{$classId}';
    var scoresDetails = [];
    var startDate = '',endDate = '';
    var startDateStr = '', endDateStr = '';
    var xAxisArr = [];
    var yAxisArr = [];
    var homeworkIdArr = [];
    var courseId='';

    getHomeworkScoreByClassId();

    function getHomeworkScoreByClassId() {
        xAxisArr = [];
        yAxisArr = [];
        homeworkIdArr = [];

        $.get('index.php?m=Home&c=TeachLearnPath&a=getHomeworkScoreByClassId', {
                class_id: classId,
                startDate: startDate,
                endDate: endDate,
                courseId:courseId,
            },
            function (res) {
                if (res == '') {
                    $('#chart').hide();
                    $('.table_cj_jiazai').hide();
                    $('.table_cj').show();
                } else {
                    $('#chart').show();
                    $('.table_cj').hide();
                    scoresDetails = res;
                    do_tj();
                }

        });
    }

    function do_tj() {
        var studentNameArr = [];

        $(scoresDetails).each(function (i, n) {
            if ($.inArray(n.homework_id, homeworkIdArr) == -1) {
                xAxisArr.push(n.homework_name);
                homeworkIdArr.push(n.homework_id);
            }
            var studentName = n.student_name;
            if ($.inArray(studentName, studentNameArr) == -1) {
                studentNameArr.push(studentName);
            }
        });

        function series(name, length) {
            this.name = name;
            this.data = new Array(length);

        }

        var seriesArray = new Array(studentNameArr.length);

        $(seriesArray).each(function (i, n) {
            seriesArray[i] = new series(studentNameArr[i], homeworkIdArr.length);
            $(seriesArray[i].data).each(function (index, nouse) {
                seriesArray[i].data[index] = null;
            });
        });

        $(scoresDetails).each(function (i, n) {
            var studentName = n.student_name;
            $(studentNameArr).each(function (iName, SName) {
                if (SName == studentName)
                    seriesArray[iName].data[$.inArray(n.homework_id, homeworkIdArr)] = parseInt(n.points);
            });
        });

        $(seriesArray).each(function (i, n) {
            yAxisArr.push(n);
        });

        if(startDateStr == endDateStr){

            $('#chart').highcharts({
                chart: {
                    type: 'line'
                },
                credits: {
                    enabled: true,
                    text: '',
                    href: 'javacript:'
                },
                title: {
                    text: startDateStr + '学生成绩轨迹横向对比分析' + (scoresDetails.length == 0 ? '（没有数据）' : ''),
                    x: -20 //center
                },
                xAxis: {
                    title: {
                        text: '作业名称',
                        style: {
                            color: '#333',
                            fontWeight: 'bold'
                        },
                        margin: 20
                    },
                    categories: xAxisArr,
                    labels: {
                        style: {
                            color: '#333'
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: '成绩',
                        style: {
                            color: '#333',
                            fontWeight: 'bold'
                        },
                        margin: 20,
                        rotation: 0
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }],
                    labels: {
                        style: {
                            color: '#333'
                        }
                    }
                },
                tooltip: {
                    valueSuffix: '分'
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'top',
                    borderWidth: 0,
                    y: 20,
                    itemMarginTop: 5,
                    itemMarginBottom: 5,
                    maxHeight: 300
                },
                lang: {
                    noData: "无数据"
                },
                noData: {
                    style: {
                        fontWeight: 'bold',
                        fontSize: '15px',
                        color: '#303030'
                    }
                },
                series: yAxisArr
            });
        } else {
            $('#chart').highcharts({
                credits: {
                    text: '',
                    href: 'http://www.jtypt.com'
                },
                title: {
                    text: startDateStr + '~' + endDateStr + '学生成绩轨迹横向对比分析' + (scoresDetails.length == 0 ? '（没有数据）' : ''),
                    x: -20 //center
                },
                xAxis: {
                    title: {
                        text: '作业名称',
                        style: {
                            color: '#333',
                            fontWeight: 'bold'
                        },
                        margin: 20
                    },
                    categories: xAxisArr,
                    labels: {
                        style: {
                            color: '#333'
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: '成绩',
                        style: {
                            color: '#333',
                            fontWeight: 'bold'
                        },
                        margin: 20
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }],
                    labels: {
                        style: {
                            color: '#333'
                        }
                    }
                },
                tooltip: {
                    valueSuffix: '分'
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'top',
                    borderWidth: 0,
                    y: 20,
                    itemMarginTop: 5,
                    itemMarginBottom: 5,
                    maxHeight: 300
                },
                lang: {
                    noData: "无数据"
                },
                noData: {
                    style: {
                        fontWeight: 'bold',
                        fontSize: '15px',
                        color: '#303030'
                    }
                },
                series: yAxisArr
            });
        }

        $(window).resize();
    }
</script>
<script>
    $(function () {
        $('.filterTable_item').click(function () {
            $('.filterTable_item').removeClass('selected');
            var target = $(this).attr('data-id');
            $('.filter_show').hide();
            $('#filter_show_' + target).show();
            $(this).addClass('selected');
            event.stopPropagation();
        });
        $('#contentWrapper').bind('click', function () {
            $('.filter_show').hide();
        })
        $('#fullscreen_ctrl,#escfullscreen_ctrl').click(function(){

        });

        $('#course_id').change(function () {
            courseId = $(this).val();
            getHomeworkScoreByClassId();
        });
    });

    function filterTongji(type) {
        window.setTimeout(function () {
            $('.filter_show').hide();
        }, 200);

        switch (type) {
            case 'day':
                var day = $('#filter_day').val();
                if (day == '') {
                    break;
                }
                startDate = day + ' 00:00:00';
                endDate = day + ' 23:59:59';
                break;
            case 'week':
                var getDaysByWeek = function (year, index) {
                    var d = new Date(year, 0, 1);
                    while (d.getDay() != 1) {
                        d.setDate(d.getDate() + 1);
                    }
                    var to = new Date(year + 1, 0, 1);
                    var i = 1;
                    var arr = [];
                    for (var from = d; from < to;) {
                        if (i == index) {
                            arr.push(from.getFullYear() + "-" + (from.getMonth() + 1) + "-" + from.getDate());
                        }
                        var j = 6;
                        while (j > 0) {
                            from.setDate(from.getDate() + 1);
                            if (i == index) {
                                arr.push(from.getFullYear() + "-" + (from.getMonth() + 1) + "-" + from.getDate());
                            }
                            j--;
                        }
                        if (i == index) {
                            return arr;
                        }
                        from.setDate(from.getDate() + 1);
                        i++;
                    }
                }
                var week = $('#filter_week').val();
                var year = parseInt(week.split('-')[0]);
                var week = parseInt(week.split('-')[1].replace('W', ''));
                var arr = getDaysByWeek(year, week);
                startDate = arr[0] + ' 00:00:00';
                endDate = arr[6] + ' 23:59:59';
                break;
            case 'month':
                var filter_month = $('#filter_month').val();
                var year = parseInt(filter_month.split('-')[0]);
                var month = parseInt(filter_month.split('-')[1]);
                var lastDay = getLastDayInMonth(year, month);
                startDate = filter_month + '-01 00:00:00';
                endDate = filter_month + '-' + lastDay + ' 23:59:59';
                break;
            case 'term':
                var filter_term = $('#filter_term').val();
                startDate = filter_term.split('~')[0] + '-01 00:00:00';
                var filter_term_2 = filter_term.split('~')[0]
                var year = parseInt(filter_term_2.split('-')[0]);
                var month = parseInt(filter_term_2.split('-')[1]);
                var lastDay = getLastDayInMonth(year, month);
                endDate = filter_term.split('~')[1] + '-' + lastDay + ' 23:59:59';
                break;
            case 'year':
                var filter_term = $('#filter_year').val();
                startDate = filter_term.split('~')[0] + '-01 00:00:00';
                var filter_term_2 = filter_term.split('~')[0]
                var year = parseInt(filter_term_2.split('-')[0]);
                var month = parseInt(filter_term_2.split('-')[1]);
                var lastDay = getLastDayInMonth(year, month);
                endDate = filter_term.split('~')[1] + '-' + lastDay + ' 23:59:59';
                break;
        }

        if (startDate == '' || endDate == '') {
            return;
        }
        startDateStr = startDate.substring(0, startDate.indexOf(' '));
        endDateStr = endDate.substring(0, endDate.indexOf(' '));
        startDate = new Date(startDate).getTime().toString();
        endDate = new Date(endDate).getTime().toString();
        startDate = startDate.substring(0, startDate.length - 3);
        endDate = endDate.substring(0, endDate.length - 3);

        getHomeworkScoreByClassId();
    }

    //月份里的最后一天
    function getLastDayInMonth(year, month) {
        var new_year = year;
        var new_month = month++;
        if (month > 12) {
            new_month -= 12;
            new_year++;
        }
        var new_date = new Date(new_year, new_month, 1);
        return (new Date(new_date.getTime() - 1000 * 60 * 60 * 24)).getDate();
    }


    var before_val=$("#filter_year").val();
    var before_text=$("#filter_year").find('option:selected').text();

    //filter_year
    var date1 = new Date().Format("yyyy-MM");
    $("#filter_year").change(function(){
        var before_date=$("#filter_year").val();
        var before_date_text=$("#filter_year").find('option:selected').text();

        var temp_start_date=before_date.split('~');
        temp_start_date=temp_start_date[0];
        if(date1<temp_start_date){
            $("#filter_year").val(before_val);
            $("#filter_year").find('option:selected').text(before_text);
        }else{
            before_val=before_date;
            before_text=before_date_text;
        }
    });


    var before_term_val=$("#filter_term").val();
    var before_term_text=$("#filter_term").find('option:selected').text();
    $("#filter_term").change(function(){
        var before_term_date=$("#filter_term").val();
        var before_term_date_text=$("#filter_term").find('option:selected').text();

        var temp_start_date=before_term_date.split('~');
        temp_start_date=temp_start_date[0];
        if(date1<temp_start_date){
            $("#filter_term").val(before_term_val);
            $("#filter_term").find('option:selected').text(before_term_text);
        }else{
            before_term_val=before_term_date;
            before_term_text=before_term_date_text;
        }
    });

</script>
<script>
    var list_student_tpl = ['<tr id="l_{0}">',
        '	<td class="text-center">',
        '		{1}',
        '	</td>',
        '	<td>',
        '		{2}',
        '	</td>',
        '	<td class="text-center">',
        '		{3}',
        '	</td>',
        '	<td class="text-center">',
        '		{4}',
        '	</td>',
        '	<td class="text-center">',
        '		{5}',
        '	</td>',
        '	<td class="text-center">',
        '		{6}',
        '	</td>',
        '	<td class="text-center">',
        '		<a target="_blank" href="{:U(\'Teach/learningPath?id=\')}{0}&class_id={7}"',
        '		   title="活动表现" class="button mb5">活动表现</a>',
        '		<a target="_blank" href="{:U(\'Teach/wrongHomeworkDetail?student_id=\')}{0}" title="错题集" class="button">错题集</a><br/>',
        '	</td>',
        '	<td class="text-center">',
        '	</td>',
        '</tr>'].join("");



    function searchStudents() {
        var parms = {
            'name': $('#filter_name').val(),
            'sex': $('#filter_sex').val(),
            'student_id': $('#filter_student_id').val(),
            'parent_tel': $('#filter_parent_tel').val(),
            'classId': '{$classId}'
        };

        $.post('__URL__/ajax_classStudentList', parms, function (res) {
            var html = [];
            $.each(res, function (i, n) {
                var email = n.email == null ? '' : n.email;
                var birthday = '';
                if (n.birth_date != null && n.birth_date != '') {
                    birthday = new Date(parseInt(n.birth_date) * 1000);
                    birthday = birthday.getFullYear() + '-' + (birthday.getMonth() + 1) + '-' + birthday.getDate();
                }

                html.push(list_student_tpl.format(n.id, n.student_name, n.sex, birthday, n.student_id, n.parent_tel, email, n.class_id));
            });
            $('#list_student_tbody').html(html.join(''));
        });
    }

</script>
<!--开始时间 结束时间-->
<script>
    !function(){
        laydate.skin('yalan');//切换皮肤，请查看skins下面皮肤库
    }();

    //活动起始时间
    var actstart = {
        elem: '#startTime',
        format: 'YYYY-MM-DD',
//		min: laydate.now(), //设定最小日期为当前日期
        max: '2099-06-16', //最大日期
        istime: true,
        istoday: false,
        choose: function(datas){
            actend.min = datas; //开始日选好后，重置结束日的最小日期
            actend.start = datas; //将结束日的初始值设定为开始日
            time('#startTime')
        }
    };

    var actend = {
        elem: '#endTime',
        format: 'YYYY-MM-DD',
//		min: laydate.now(),
        max: '2099-06-16',
        istime: true,
        istoday: false,
        choose: function(datas){
            actstart.max = datas; //结束日选好后，充值开始日的最大日期
            time('#endTime')
        }
    };
    laydate(actstart);
    laydate(actend);
</script>

<script>
    var startLeft;
    $('#startTime').click(function(){
        startLeft = $('#laydate_box').css('left');
    })
    var a = 0;
    function time(id_){
        if($(id_).val() != '') {
            $(id_).siblings('label').addClass('yellow')
        } else {
            $(id_).siblings('label').removeClass('yellow')
        }
        $('#laydate_clear').click(function(){
            if($('#laydate_box').css('left') == startLeft) {
                $('#startTime').siblings('label').removeClass('yellow');
            } else {
                $('#endTime').siblings('label').removeClass('yellow')
            }
        })
    }
</script>

<script>
    function searchTime() {
        var startDatecopy = $('#startTime').val();
        var endDatecopy = $('#endTime').val();

        $('#startTime').siblings('label').removeClass('yellow');
        $('#endTime').siblings('label').removeClass('yellow');

        //var startDate = '',endDate = '';
        startDateStr = startDatecopy.substring(0, startDatecopy.indexOf(' '));
        endDateStr = endDatecopy.substring(0, endDatecopy.indexOf(' '));
        startDate = startDatecopy;
        endDate = endDatecopy;

        getHomeworkScoreByClassId();


    }
</script>
