<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>上传资料</title>
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <link href="__PUBLIC__/js/fine-uploader/fine-uploader-new-app.css" rel="stylesheet" type="text/css"/>
    <link href="__PUBLIC__/css/appCommon.css" rel="stylesheet" type="text/css"/>

    <script src="http://apps.bdimg.com/libs/jquery/1.10.1/jquery.js" type="text/javascript"></script>
    <script src="__PUBLIC__/js/rem.js"></script>
    <style>
        * {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: "微软雅黑"
		}

		html, body {
			width: 100%;
		}

		body {
			font-size: 18px;
			color: #333;
			padding: 5%;
		}

		.form_section {
			width: 100%;
		}

		.form_section label {
			display: block;
			line-height: 34px;
		}

		.form_section .form-control {
			width: 100%;
			min-height: 40px;
			padding: 10px;
			font-size: 18px;
			border: 1px solid #d4d4d4;
			border-radius: 5px;
			outline: none;
		}

		.form_section textarea {
			resize: none;
		}

		.qq-upload-button {
			border: 1px solid #f06359;
			background: #f06359;
			border-radius: 5px;
			margin-bottom: 0;
		}

		.qq-upload-button-hover {
			background: #f06359;
		}

		.qq-uploader {
			border: none;
			padding: 0;
			margin-top: 2rem;
			min-height: inherit;
			border-radius: 0;
			overflow-y: inherit;
		}

		.uploadRemark {
			clear: both;
			font-size: 12px;
			color: #999;
			padding: 5px 0;
            margin-bottom:10px
		}

		.saveButton {
			background: none;
			outline: none;
			border: none;
			width: 100%;
			color: #fff;
			background: #f06359;
			line-height: 3.5rem;
			font-size: 1.4rem;
			text-align: center;
			margin: 1rem 0;
		}

		.uploadImg1 {
			border: none;
			background: none;
			outline: none;
			background: #f06359;
			color: #fff;
			width: 105px;
    		padding: 7px 10px;
    		text-align: center;
			font-size: 16px;
			border-radius: 5px;
			margin-top: 2rem;
		}

		.uploadRemark1 {
			clear: both;
			font-size: 12px;
			color: #999;
			padding: 5px 0;
		}

		.text-center {
			text-align: center;
		}

		.fileBox {
			position: relative;
			display: inline-block;
			margin: 0 auto;
			max-width: 70%;
			min-width: 150px;
			min-height: 150px;
		}

		.fileBox .circle {
			width: 100px;
			height: 100px;
			position: absolute;
			border-radius: 50%;
			background: #f06359;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
			margin: auto;
		}

		.fileBox .classify_ul{
			border: none !important;
		}

		.fileBox .pie_left, .pie_right {
			width:100px;
			height:100px;
			position: absolute;
			top: 0;
			left: 0;
		}

		.fileBox .p_left, .p_right {
			width:100px;
			height:100px;
			background:#e6e7e7;
			border-radius: 50%;
			position: absolute;
			top: 0;
			left: 0;
		}

		.fileBox .pie_right, .fileBox .p_right {
			clip:rect(0,auto,auto,50px);
		}

		.fileBox .pie_left, .fileBox .p_left {
			clip:rect(0,50px,auto,0);
		}

		.fileBox .mask {
			width: 90px;
			height: 90px;
			border-radius: 50%;
			left: 5px;
			top: 5px;
			background: #efefef;
			position: absolute;
			text-align: center;
			line-height: 92px;
			font-size: 16px;
			font-weight: bold;
			color: #333;
		}

		.fileBox .deleteImg {
			position: absolute;
			width: 25px;
			height: 25px;
			top: -15px;
			right: -15px;
		}

		.fileBox .fileImg {
			width: 100%;
		}

		.upload_li {
			width: 30%;
			display: inline-block;
			margin: 1.6%
		}

		.upload_bg {
			z-index: 9999;
			width: 100%;
			height: 100%;
			background-color: red;
		}

		.deleteImg1 {
			position: absolute;
			width: 20px;
			height: 20px;
			top: -8px;
			right: -8px;
			margin: 0;
			z-index: 10010
		}

		.upload_img {
			display: block;
			height: 100%;
			margin: auto;
			max-width: 100%
		}

		.upload_imgbox {
			width: 100%;
			position: relative;
			border: 1px solid #eee;
			height: 100px;
		}

		.qq-upload-file {
			display: inline-block;
			width: 100%;
			text-overflow: inherit;
			white-space: inherit;
			overflow-x: inherit;
			word-break: break-all;
			font-size: 1rem;
			height: auto;
			padding: 0.2rem 0;
			line-height: 1.5rem;
			margin: 0;
		}

		.qq-upload-list li.qq-upload-success {
			background-color: inherit;
			color: #424242;
			border-bottom: none;
			border-top: none;
		}

		.qq-upload-list {
			box-shadow: inherit;
			overflow-y: inherit;
		}

		.qq-upload-list li {
			width: 30%;
			margin: 0 1.6%;
			float: left;
			margin-bottom: 1rem;
			background-color: inherit;
			position: relative;
		}

		.qq-progress-bar {
			display: block;
			background: rgba(0,0,0,.8);
			width: 0%;
			height: 6px;
			border-radius: 3px;
			position: absolute;
			top: 0 !important;
			bottom: 0;
			margin: auto;
			z-index: 10000
		}

		.upload_selecter {
			position: absolute;
			width: 100%;
			height:  100%;
			top: 0;
			z-index: 9999;
			background: rgba(255,255,255,.8)
/*			overflow: hidden;*/
		}

		.upload_btnbox {
			width: 100%;
			height: 100%;
		}

		.upload_btn {
			z-index: 10001;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			height: 25px;
			line-height: 25px;
			padding: 0;
			margin: auto;
			width: 70%;
			background-color: #f06359;
    		border-color: #f06359;
			color: #fff
		}

		.upload_name {
			height: 3.4rem;
			overflow: hidden;
		}

		.upload_name p {
			text-overflow: ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
		}

		.check_imgbox {
			width: 100%;
			height: 100%;
			position: relative;
		}

		.check_border {
			width: 100%;
			height: 102px;
			border: 1px solid #eee;
			position: absolute;
			top: 0;
			left: 0;
			z-index: -1
		}

		.check_img {
			max-width: 100%;
			height: 100px;
			margin: 0;
			display: block;
			margin: 0 auto;
		}

		.check_a {
			display: block;
			color: #424242;
			text-decoration: none;
			border: 1px solid rgba(255,255,255,0)
		}

		.check_span {
			display: inline-block;
			width: 100%;
			text-overflow: inherit;
			white-space: inherit;
			overflow-x: inherit;
			word-break: break-all;
			font-size: 18px;
			height: auto;
			padding: 0.2rem 0;
			line-height: 1.5rem;
			margin: 0;
			text-overflow: ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
		}

		.check_close {
			position: absolute;
			width: 20px;
			height: 20px;
			top: -8px;
			right: -8px;
			margin: 0;
			z-index: 10010
		}

		.maskBox {
			position: relative;
		}

		.maskBox .maskDiv {
			position: absolute;
			height: 100%;
			width: 100%;
			bottom: 0;
			left: 0;
			z-index: 100
		}

/*
		input, select, textarea {
			-webkit-appearance: none !important;
		}
*/
    </style>

</head>
<body>
<form id="workUploadForm" action="/index.php?m=Home&c=Activity&a=activityWorkPublish&role={$role}&userId={$userId}" method="post" onsubmit="$('#saveButton').attr('disabled',true);">
    <input type="hidden" name="id" value="{$activityId}">
    <div class="overBox">
        <?php $selectFields = explode(',',$activityInfo['selectedfields']); ?>
        <?php $uploadInfoSelectFields = explode(',',$activityInfo['upload_info']); ?>

        <?php if(in_array('2',$selectFields) && $role== 2) { ?>
        <div class="form_section maskBox">
			<label for="">学科</label>
			<input type="text" class="form-control" value="{$regInfo.course_name}" {$view == 1? 'readonly':''} readonly>
        	<div class="maskDiv"></div>
        </div>
        <?php } ?>
        <?php if(in_array('1',$uploadInfoSelectFields)  && ($role == 2)) { ?>
        <div class="form_section">
            <label for="">年级</label>
			<select id="grade_id" name="grade_id" class="form-control" {$view == 1? 'disabled':''} required>
				<option value="">-请选择-</option>
				<volist name="grades" id="dataGrade" empty="暂时没有信息">
					<option value="{$dataGrade.grade}" {$dataGrade['grade_name']==$workInfo['grade']?'selected':''}>{$dataGrade.grade_name}</option>
				</volist>
			</select>
        </div>
        <?php } ?>
        <?php if(in_array('3',$uploadInfoSelectFields)) { ?>
        <div class="form_section">
            <label for="">名称</label>
			<input {$view == 1? 'readonly':''} type="text" name="name" id="name" class="form-control" required placeholder="必填，不超过40个字" maxlength="40" value="{$workInfo.works_name}" >
        </div>
        <?php } ?>
        <?php if(in_array('4',$uploadInfoSelectFields)) { ?>
        <div class="form_section">
            <label for="">描述</label>
			<textarea {$view == 1? 'readonly':''} id="description" name="description" rows="5" class="form-control" required placeholder="必填，不超过100个字" maxlength="100" value="" >{$workInfo.works_description}</textarea>
        </div>
        <?php } ?>
        <input type='hidden' name='file_name' id='file_name' />
        <input type='hidden' name='unique_string' id='unique_string' />
        <input type='hidden' name='vid_image_path' id='vid_image_path' />
        <input type='hidden' name='vid_transition' id='vid_transition' />
        <input type='hidden' name='vid' id='vid' />
        <input type='hidden' name='vid_fullpath' id='vid_fullpath' />

        <!--作者寄语-->
        <?php if(in_array('5',$uploadInfoSelectFields)) { ?>
        <div class="form_section">
            <label for="">参赛寄语</label>
			<textarea {$view == 1? 'readonly':''} id="authorContent" name="authorContent" rows="5" class="form-control" placeholder="选填，不超过100个字" maxlength="100" value="">{$workInfo.author_remarks}</textarea>
        </div>
        <?php } ?>
        <?php if(0 == $view) :?>
        <button class="uploadImg1" type="button">上传资料</button>
        <div class="uploadRemark1"></div>
        <?php endif; ?>
        <div id="fine-uploader" style="display: block;">

        </div>

		<!--上传的文件-->
      <!--<div class="text-center">-->
      		<!--<div class="fileBox">-->
				<!--<img src="http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/deleteImg.png" alt="" class="deleteImg">-->
				<!--<a href="javascript:;">-->
					<!--<img src="http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/carrot.png" alt="" class="fileImg">-->
				<!--</a>-->
				<!--<div class="circle">-->
					<!--<div class="pie_left"><div class="p_left"></div></div>-->
					<!--<div class="pie_right"><div class="p_right"></div></div>-->
					<!--<div class="mask"><span>30</span>%</div>-->
				<!--</div>-->
		   <!--</div>-->
      <!--</div>-->


        <?php if(0 == $view) :?>
        <div class="form-actions" style="background:none">
            <!--<button type="button" class="btn btn-primary" id="uploadButton">开始上传</button>-->
            <button type="submit" class="saveButton" id="saveButton" >确定</button>
        </div>
        <?php endif; ?>

</form>
<include file="./Application/ApiInterface/View/Version1_1/Common/uploader-image.html"/>
<script src="__PUBLIC__/js/md5/browser-md5-file.js" defer async="true"></script>
<script src="__PUBLIC__/js/common.js" ></script>
<script src="__PUBLIC__/js/notify/notifyApp.js" defer async="true"></script>
<script src="__PUBLIC__/js/fine-uploader/fine-uploader-v2beta-app.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/uploaderClass.js"></script>

<script>
    getQueryString()
    $(function() {
        var extList = '{$activityInfo['work_extension']}'.split(',');
        $(extList).each(function (i, n) {
            extList[i] = '.' + n;
        })
        function in_array(search,array){
            for(var i in array){
                if(array[i]==search){
                    return true;
                }
            }
            return false;
        }
        function getThumbNail(filePath)
        {
            var ext = get_suffix(filePath.toLowerCase());
            var videoExt =  Array('.mpg','.avi','.mp4','.flv','.wmv','.mov') ;
            var audioExt =  Array('.mp3');
            var pptExt = Array('.ppt','.pptx');
            var pdfExt = Array('.pdf')
            var docExt = Array('.doc','.docx');
            var zipExt = Array('.zip','.rar');
            var imgExt = Array('.png','.jpg');
            if(in_array(ext,videoExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/vedio.png';
            }
            if(in_array(ext,audioExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/voice.png';
            }
            if(in_array(ext,pptExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/ppt.png';
            }
            if(in_array(ext,pdfExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/pdf.png';
            }
            if(in_array(ext,zipExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/zip.png';
            }
            if(in_array(ext,docExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/word.png';
            }
            if(in_array(ext,imgExt))
            {
                return '{$oss_path}'+filePath;
            }
            return "http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/carrot.png";
        }
        $('.uploadImg1').html('上传资料');

        var uploaderParams = {
            1: {
                id: 'fine-uploader',
                filterArray: extList,
                mutiple: false,
                thumbNail: getThumbNail
            }
        };
        var uploader = new uploaderOss.initUploader(uploaderParams);

         var uploadedObject = eval('(' + '<?php echo json_encode($works2); ?>' + ')');
        var itemTemplate ='\
                <li class="qq-file-id-0 qq-upload-success" qq-file-id="{0}">\
                <div class="check_imgbox">\
					<div class="check_border"></div>\
                    <a class="check_a" target="" flag="{4}" attr_path = "{$oss_path}{2}" href="javascript:;"><img src="{3}" class="qq-thumbnail-selector check_img" qq-max-size="100" qq-server-scale><span class="qq-upload-file-selector check_span" title="{1}">{1}</span></a>\
                <?php if(0 == $view) echo '<img src="http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/deleteImg.png" alt="" class="qq-upload-cancel-selector qq-upload-cancel deleteImg check_close">\\'; ?>
                </div>\
                </li>';
        var htmls = Array();
        var uploadedObjectSecond = Array();
        $(uploadedObject).each(
         function(i,n){
            var obj = {};
            obj.vid = n.vid;
            obj.vid_fullpath = n.vid_fullpath;
            obj.file_name = n.works_file_name + get_suffix(n.works_file_path);
            obj.file_path = n.works_file_path;
            uploadedObjectSecond.push(obj);
            htmls.push(itemTemplate.format(-1-i,n.works_file_name, obj.file_path,getThumbNail(n.works_file_path),n.flag))
        })
        uploader.initUploadedObject(1,uploadedObjectSecond, htmls);

        $('.check_a').on('click',function(){
        	var u = navigator.userAgent;
			var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
			var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端

        	var attr_path = $(this).attr('attr_path');
        	var ext = get_suffix(attr_path.toLowerCase());
            var videoExt =  Array('.mpg','.avi','.mp4','.flv','.wmv','.mov') ;
            var audioExt =  Array('.mp3');
            var pptExt = Array('.ppt','.pptx');
            var pdfExt = Array('.pdf')
            var docExt = Array('.doc','.docx');
            var zipExt = Array('.zip','.rar');
            var imgExt = Array('.png','.jpg');
            if(in_array(ext,videoExt))
            {
                console.log('video');
                var attr_type = 'video';
                location.href = "http://" + "{$_SERVER['SERVER_NAME']}" + "/ApiInterface/Version1_1/Activity/activityBox?detailsType="+ attr_type+"?detailsPath="+attr_path;
            }
            if(in_array(ext,audioExt))
            {
                console.log('voice');
                var attr_type = 'audio';
                location.href = "http://" + "{$_SERVER['SERVER_NAME']}" + "/ApiInterface/Version1_1/Activity/activityBox?detailsType="+ attr_type+"?detailsPath="+attr_path;
            }
            if(in_array(ext,pptExt) || in_array(ext,docExt))
            {
                if (isiOS) {
                	$(this).attr('href',attr_path);
				} else if (isAndroid) {
					var flag = $(this).attr('flag');
                    if(1 == flag) //未转换
                    location.href = "/ApiInterface/Version1_1/Activity/dataConversion";
                    else
                    location.href = "http://" + "{$_SERVER['SERVER_NAME']}" + "__PUBLIC__/pdfjs/viewer/viewer.html?f={$oss_path}" + "Activity/Works/" + {$works2[0].activity_works_id} + "/"+get_prefix(attr_path) +".pdf";
				}
            }
            if(in_array(ext,pdfExt))
            {
                console.log('pdf');
                if (isiOS) {
                	$(this).attr('href',attr_path);
				} else if (isAndroid) {
					location.href = "http://" + "{$_SERVER['SERVER_NAME']}" + "__PUBLIC__/pdfjs/viewer/viewer.html?f=" + attr_path;
				}
            }
            if(in_array(ext,zipExt))
            {
                 console.log('zip');
                 // $(this).attr('href',attr_path);
				$.NotifyBox.NotifyPromptOne('提示','暂时不支持该格式','确定')
            }

            if(in_array(ext,imgExt))
            {
                console.log('image');
                var attr_type = 'image';
                location.href = "http://" + "{$_SERVER['SERVER_NAME']}" + "/ApiInterface/Version1_1/Activity/activityBox?detailsType="+ attr_type+"?detailsPath="+attr_path;
            }
        })

        $('#saveButton').click(function(){
            var imgPath = '';
            var uploadInfo = uploader.getUploadInfo(1);
            if (false == uploadInfo)
                return false;
            try {
                for (var key in uploadInfo) {
                    imgPath = uploadInfo[key]['file_path'];
                    break;
                }
            } catch (e) {
                ;
            }

            if($('#grade_id').val() == '') {
				$.NotifyBox.NotifyPromptOne('提示','请选择年级','确定');
                return false;
			} else if($('#name').val() != undefined && $.trim($('#name').val()) == '') {
				$.NotifyBox.NotifyPromptOne('提示','请添加名称','确定');
                return false;
			} else if($('#description').val() != undefined && $.trim($('#description').val()) == '') {
				$.NotifyBox.NotifyPromptOne('提示','请添加描述','确定');
                return false;
			} else if(imgPath == '') {
//                alert('请上传图片/视频');
				$.NotifyBox.NotifyPromptOne('提示','请上传图片/视频','确定');
                return false;
            }
            $('#unique_string').val('');
            $('#file_name').val('');
            $("#unique_vid").val();
            $("#vid_width").val();
            $("#vid_time").val();
            $("#vid_fullpath").val('');
            $("#vid_image_path").val('');
            $("#vid_transition").val('');
            $("#vid").val('');

            for (var key in uploadInfo) {
                $('#unique_string').val($('#unique_string').val() + uploadInfo[key].file_path + ',');

                $('#file_name').val($('#file_name').val() + uploadInfo[key].file_name + ',');

                var image_path = typeof(uploadInfo[key].image_path) != 'undefined' ? uploadInfo[key].image_path : '0';
                $('#vid_image_path').val($('#vid_image_path').val() + image_path + ',');

                var vid_transition = typeof(uploadInfo[key].is_transition) != 'undefined' ? uploadInfo[key].is_transition : '0';
                $('#vid_transition').val($('#vid_transition').val() + vid_transition + ',');

                var vid = typeof(uploadInfo[key].vid) != 'undefined' ? uploadInfo[key].vid : '0';
                $('#vid').val($('#vid').val() + vid + ',');

                var vid_fullpath = typeof(uploadInfo[key].vid_fullpath) != 'undefined' ? uploadInfo[key].vid_fullpath : '0';
                $('#vid_fullpath').val($('#vid_fullpath').val() + vid_fullpath + ',');
            }
            $('#file_name').val($('#file_name').val().substr(0, $('#file_name').val().length - 1));
            $('#unique_string').val($('#unique_string').val().substr(0, $('#unique_string').val().length - 1));
            $('#vid_image_path').val($('#vid_image_path').val().substr(0, $('#vid_image_path').val().length - 1));
            $('#vid_transition').val($('#vid_transition').val().substr(0, $('#vid_transition').val().length - 1));
            $('#vid').val($('#vid').val().substr(0, $('#vid').val().length - 1));
            $('#vid_fullpath').val($('#vid_fullpath').val().substr(0, $('#vid_fullpath').val().length - 1));

            return true;
        });
        var hintText = ''
        if(in_array('.mp3',extList))
            hintText += '*音频（mp3）单个文件不超过50MB<br/>';
        if(in_array('.jpg',extList))
            hintText += '*图片（jpg/png）单个文件不超过5MB<br/>';
        if(in_array('.doc',extList))
            hintText += '*WORD（doc/docx）单个文件不超过150MB<br/>';
        if(in_array('.ppt',extList))
            hintText += '*PPT（ppt/pptx）单个文件不超过50MB<br/>';
        if(in_array('.rar',extList))
            hintText += '*压缩包（rar/zip）单个文件不超过1024MB<br/>';
        if(in_array('.avi',extList))
            hintText += '*视频（mp4/mpg/mov/wma/flv/avi）单个文件不超过1024MB<br/>';
        $('.uploadRemark1').html(hintText);
        //点击去触发真实的上传文件
        $(".uploadImg1").click(function(){
            $("#fine-uploader").find(':file').trigger('click');
        });

})
</script>
<script src="__PUBLIC__/js/jquery.form.js"></script>
<script>
    $(function() {
        var options = {
            success: showResponse, // post-submit callback
            resetForm: false,
            dataType: 'json'
        };

        // bind to the form's submit event
        $('#workUploadForm').submit(function () {
            $(this).ajaxSubmit(options);
            $('#saveButton').attr('disabled', true);
            return false;
        });


        function showResponse(responseText, statusText) {
            switch (responseText.status) {
                case 200:
//                   alert('提交成功');
					 $.NotifyBox.NotifyPromptOneC('提示','提交成功','确定',function(){
                        //window.location.replace('/ApiInterface/Version1_1/Activity/activityDetails?id={$activityId}&userId={$userId}&role={$role}');
                        history.go(-1);
						  if(AppFunction.goback() == undefined) {
							 AppFunction.goback()
						 }
                     });
                    break;
                default:
//                    alert(responseText.message);
					$.NotifyBox.NotifyPromptOne('提示',responseText.message,'确定');
                    $('#saveButton').attr('disabled', false);
                    break;
            }

        }


    })
</script>

<!--
<script>
	$("#fine-uploader").bind('DOMNodeRemoved', function(e) {
			$(".upload_name").each(function (i) {
				var divH = $(this).height();
				var $p = $("p", $(this)).eq(0);
				while ($p.outerHeight() > divH) {
					$p.text($p.text().replace(/(\s)*([a-zA-Z0-9]+|\W)(\.\.\.)?$/, "..."));
				};
			});
        });
</script>
-->
</body>
</html>
