<layout name="admin_layout_back"/>
<link href="__PUBLIC_METRO__/css/app/table_list.css?v=4.0" type="text/css" rel="stylesheet">
<link href="__PUBLIC__/css/jquery.ui.datepicker.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/css/adminActivity.css" rel="stylesheet" type="text/css" />
<link href="__PUBLIC__/js/fine-uploader/fine-uploader-new.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" type="text/css" href="__PUBLIC__/uploadify/uploadify.css">
<style media="screen">
.laydate_body .laydate_bottom, .laydate_body .laydate_top, .laydate_body .laydate_ym .laydate_yms {
  box-sizing: content-box;
}
.startEndTimeInput{
    width:100px;
}
.input_margin{
      margin: .325rem 0;
      margin-bottom: 10px
}
.qq-upload-button {
    border: 1px solid #f06359;
    background: #f06359;
    border-radius: 5px;
    margin-bottom: 0;
}

.qq-upload-button-hover {
    background: #f06359;
}

.qq-uploader {
    border: none;
    padding: 0;
    margin-top: 2rem;
    min-height: inherit;
    border-radius: 0;
    overflow-y: inherit;
}

.uploadRemark {
    clear: both;
    font-size: 12px;
    color: #999;
    padding: 5px 0;
    margin-bottom:10px
}

.saveButton {
    background: none;
    outline: none;
    border: none;
    width: 100%;
    color: #fff;
    background: #f06359;
    line-height: 3.5rem;
    font-size: 1.4rem;
    text-align: center;
    margin: 1rem 0;
}

.uploadImg1 {
    border: none;
    background: none;
    outline: none;
    background: #59cde2;
    color: #fff;
    width: 105px;
    padding: 7px 10px;
    text-align: center;
    font-size: 16px;
    border-radius: 5px;

}

.uploadRemark1 {
    clear: both;
    font-size: 12px;
    color: #999;
    padding: 5px 0;
}

.text-center {
    text-align: center;
}

.fileBox {
    position: relative;
    display: inline-block;
    margin: 0 auto;
    max-width: 70%;
    min-width: 150px;
    min-height: 150px;
}

.fileBox .circle {
    width: 100px;
    height: 100px;
    position: absolute;
    border-radius: 50%;
    background: #f06359;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    margin: auto;
}

.fileBox .classify_ul{
    border: none !important;
}

.fileBox .pie_left, .pie_right {
    width:100px;
    height:100px;
    position: absolute;
    top: 0;
    left: 0;
}

.fileBox .p_left, .p_right {
    width:100px;
    height:100px;
    background:#e6e7e7;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
}

.fileBox .pie_right, .fileBox .p_right {
    clip:rect(0,auto,auto,50px);
}

.fileBox .pie_left, .fileBox .p_left {
    clip:rect(0,50px,auto,0);
}

.fileBox .mask {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    left: 5px;
    top: 5px;
    background: #efefef;
    position: absolute;
    text-align: center;
    line-height: 92px;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

.fileBox .deleteImg {
    position: absolute;
    width: 25px;
    height: 25px;
    top: -15px;
    right: -15px;
}

.fileBox .fileImg {
    width: 100%;
}

.upload_li {
    width: 30%;
    display: inline-block;
    margin: 1.6%
}

.upload_bg {
    z-index: 9999;
    width: 100%;
    height: 100%;
    background-color: red;
}

.deleteImg1 {
    position: absolute;
    width: 20px;
    height: 20px;
    top: -8px;
    right: -8px;
    margin: 0;
    z-index: 10010
}

.upload_img {
    display: block;
    height: 100%;
    margin: auto;
    max-width: 100%
}

.upload_imgbox {
    width: 100%;
    position: relative;
    border: 1px solid #eee;
    height: 100px;
}

.qq-upload-file {
    display: inline-block;
    width: 100%;
    text-overflow: inherit;
    white-space: inherit;
    overflow-x: inherit;
    word-break: break-all;
    font-size: 1rem;
    height: auto;
    padding: 0.2rem 0;
    line-height: 1.5rem;
    margin: 0;
}

.qq-upload-list li.qq-upload-success {
    background-color: inherit;
    color: #424242;
    border-bottom: none;
    border-top: none;
}

.qq-upload-list {
    box-shadow: inherit;
    overflow-y: inherit;
}

.qq-upload-list li {
    width: 30%;
    margin: 0 1.6%;
    float: left;
    margin-bottom: 1rem;
    background-color: inherit;
    position: relative;
}

.qq-progress-bar {
    display: block;
    background: rgba(0,0,0,.8);
    width: 0%;
    height: 6px;
    border-radius: 3px;
    position: absolute;
    top: 0 !important;
    bottom: 0;
    margin: auto;
    z-index: 10000
}

.upload_selecter {
    position: absolute;
    width: 100%;
    height:  100%;
    top: 0;
    z-index: 9999;
    background: rgba(255,255,255,.8)
    /*			overflow: hidden;*/
}

.upload_btnbox {
    width: 100%;
    height: 100%;
}

.upload_btn {
    z-index: 10001;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    height: 25px;
    line-height: 25px;
    padding: 0;
    margin: auto;
    width: 70%;
    background-color: #f06359;
    border-color: #f06359;
    color: #fff
}

.upload_name {
    height: 3.4rem;
    overflow: hidden;
}

.upload_name p {
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.check_imgbox {
    width: 100%;
    height: 100%;
    position: relative;
}

.check_border {
    width: 100%;
    height: 102px;
    border: 1px solid #eee;
    position: absolute;
    top: 0;
    left: 0;
    z-index: -1
}

.check_img {
    max-width: 100%;
    height: 100px;
    margin: 0;
    display: block;
    margin: 0 auto;
}

.check_a {
    display: block;
    color: #424242;
    text-decoration: none;
    border: 1px solid rgba(255,255,255,0)
}

.check_span {
    display: inline-block;
    width: 100%;
    text-overflow: inherit;
    white-space: inherit;
    overflow-x: inherit;
    word-break: break-all;
    font-size: 1rem;
    height: auto;
    padding: 0.2rem 0;
    line-height: 1.5rem;
    margin: 0;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.check_close {
    position: absolute;
    width: 20px;
    height: 20px;
    top: -8px;
    right: -8px;
    margin: 0;
    z-index: 10010
}

.maskBox {
    position: relative;
}

.maskBox .maskDiv {
    position: absolute;
    height: 100%;
    width: 100%;
    bottom: 0;
    left: 0;
    z-index: 100
}
</style>
<div style="margin-bottom: 12px;">
    <a href="javascript:window.history.go(-1)" title="返回" class="button primary " style="box-sizing:border-box;">&lt; 返回</a>
</div>
<div class="titleBox">
	<p class="blueText fs18 underline1">
		{$mainTitle}
		<span class="blueSpan">
			<a href="javascript:;">{$subTitle[0]}</a>>>
			<a href="javascript:;">{$subTitle[1]}</a>
		</span>
	</p>
	<div class="underline2"></div>
</div>
<form id="submitForm" class="" action="__URL__/{$formAction}" method="post"  >
    <input type="hidden" name="id" value="{$id}"/>
  <p class="blueText fs16">{$mainTitle}</p>
  <div class="grid condensed cellBox">
  <div class="row cells3">

      <volist name="formParas" id="formParasSub">
          <if condition="$formParasSub.category eq INPUT_CATEGORY_STARTENDTIME">
              <div class="cell">
                  <label for="">{$formParasSub.name}:</label>
                  <input reg="{$formParasSub['reg']}" type="text" name="{$formParasSub.formName}" id="startTime_{$key}" data-validate-func="required" class="input_control_short input-control-before input_margin startEndTimeInput" value="{$formParasSub['value'][0]}" data-validate-hint="开始时间不能为空" placeholder="开始时间"  {$formParasSub['required'] == true?'required':''}>  -  <input reg="{$formParasSub['reg']}" type="text" name="{$formParasSub.formName}" id="endTime_{$key}" data-validate-func="required" class="input_control_short input-control-before input_margin startEndTimeInput" value="{$formParasSub['value'][1]}" data-validate-hint="结束时间不能为空" placeholder="结束时间"  {$formParasSub['required'] == true?'required':''}>
              </div>
          <elseif condition="$formParasSub.category eq INPUT_CATEGORY_RADIOSELECT"/>
              <div class="cell text-center ">
                  <?php if ($formParasSub['name'] != '') echo '<label>'.$formParasSub['name'].':</label>'; ?>
                  <volist name="formParasSub['radioValue']" id="radio" key="i">
                      <input  {$formParasSub['required'] == true?'required':''} type="radio" name="{$formParasSub.formName}" value="{$radio.value}" {$radio['value']==$formParasSub['value']? 'checked':''} class="input-control-before input_margin"><label for="" {$i==1 ? 'style="width:auto"':'style="width:auto"'}>{$radio.name}</label>
                  </volist>
              </div>
          <elseif condition="$formParasSub.category eq INPUT_CATEGORY_INPUT"/>
              <div class="cell">
                  <label>{$formParasSub.name}:</label>
                  <input reg="{$formParasSub['reg']}" {$formParasSub['required'] == true?'required':''} value="{$formParasSub['value']}" min="{$formParasSub.min}" max="{$formParasSub.max}" name="{$formParasSub.formName}" type="{$formParasSub.inputType}"  class="input-control stu_time_id input-control-before w376 "  placeholder="请输入{$formParasSub.name}" autocomplete="off" >  {$formParasSub.unit}
              </div>
          <elseif condition="$formParasSub.category eq INPUT_CATEGORY_HIDDEN"/>
              <input type="hidden" name="{$formParasSub.formName}" value="{$formParasSub.value}"/>
          <elseif condition="$formParasSub.category eq INPUT_CATEGORY_UPLOAD"/>
              <br/>

              <div class="example" style="clear:both">
                  <span class="exampl titleName" >{$formParasSub['name']}</span>
                  <span class="exampl">{$formParasSub['subtitle']}</span>
                  <button class="uploadImg{$key}" type="button">上传文件</button>
                  <div class="uploader" id="fine-uploader_{$key}">
                  </div>
                  <input id="upload_{$key}"  {$formParasSub['required'] == true?'required':''} type="hidden" name="{$formParasSub.formName}" value=""/>
              </div>
          </if>
      </volist>



    </div>

  <div class="form-actions text-center">
      <button type="submit" class="button info" id="submitBtn" onclick="return check()" >保存</button>
  </div>
</div>
</form>
<script src="__PUBLIC__/laydate/laydate.js"></script>
<script type="text/javascript">
!function(){
  laydate.skin('yalan');//切换皮肤，请查看skins下面皮肤库
}();
<volist name="formParas" id="formParasSub">
        <if condition="$formParasSub.category eq INPUT_CATEGORY_STARTENDTIME">
        !function(){
            var actstart = {
                elem: '#startTime_{$key}',
                format: 'YYYY-MM-DD',
                max: '2099-06-16', //最大日期
                istime: true,
                istoday: false,
                choose: function(datas){
                    actend.min = datas; //开始日选好后，重置结束日的最小日期
                    actend.start = datas; //将结束日的初始值设定为开始日
                }
            };

            var actend = {
                elem: '#endTime_{$key}',
                format: 'YYYY-MM-DD',
                max: '2099-06-16',
                istime: true,
                istoday: false,
                choose: function(datas){
                    actstart.max = datas; //结束日选好后，充值开始日的最大日期
                }
            };
            laydate(actstart);
            laydate(actend);
        }();
        </if>
</volist>

</script>
<include file="./Application/ApiInterface/View/Version1_1/Common/uploader-image.html"/>
<script src="__PUBLIC__/js/md5/browser-md5-file.js" defer async="true"></script>
<script src="__PUBLIC__/js/common.js" ></script>
<script src="__PUBLIC__/js/notify/adminNotify.js" defer async="true"></script>
<script src="__PUBLIC__/js/fine-uploader/fine-uploader-v2beta.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/uploaderClass.js"></script>
<script>
    $(function() {

        function in_array(search,array){
            for(var i in array){
                if(array[i]==search){
                    return true;
                }
            }
            return false;
        }
        function getThumbNail(filePath)
        {
            var ext = get_suffix(filePath.toLowerCase());
            var videoExt =  Array('.mpg','.avi','.mp4','.flv','.wmv','.mov') ;
            var audioExt =  Array('.mp3');
            var pptExt = Array('.ppt','.pptx');
            var pdfExt = Array('.pdf')
            var docExt = Array('.doc','.docx');
            var zipExt = Array('.zip','.rar');
            var imgExt = Array('.png','.jpg');
            if(in_array(ext,videoExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/vedio.png';
            }
            if(in_array(ext,audioExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/voice.png';
            }
            if(in_array(ext,pptExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/ppt.png';
            }
            if(in_array(ext,pdfExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/pdf.png';
            }
            if(in_array(ext,zipExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/zip.png';
            }
            if(in_array(ext,docExt))
            {
                return 'http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/word.png';
            }
            if(in_array(ext,imgExt))
            {
                return '{$oss_path}'+filePath;
            }
            return "http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/carrot.png";
        }

        var uploaderParams = {};
        var obj = {};
        <?php
                $obj = array();
                $uploadIndex = 0;
                for($i=0;$i<sizeof($formParas);$i++)
                {
                   if($formParas[$i]['category'] == INPUT_CATEGORY_UPLOAD)
                   {
                       $uploadIndex++;
                       $extList = explode(',',$formParas[$i]['ext']);
                     for($j=0;$j<sizeof($extList);$j++)
                     {
                      $extList[$j] = '.'.$extList[$j];
                     }
                       $obj[$uploadIndex] = array('imageRatio'=>$formParas[$i]['imageRatio'] ,'id' => 'fine-uploader_'.$i ,'filterArray'=>$extList,'multiple'=>$formParas[$i]['multiple']);
                   }

                }
                $obj = json_encode($obj);
                ?>

        var uploaderParams = JSON.parse('{$obj}');
        for (var obj in uploaderParams){
            uploaderParams[obj].thumbNail = getThumbNail;
        }


        var uploader = new uploaderOss.initUploader(uploaderParams);
        var itemTemplate ='\
                <li class="qq-file-id-0 qq-upload-success" qq-file-id="{0}">\
                <div class="check_imgbox">\
					<div class="check_border"></div>\
                    <a class="check_a" href="{$oss_path}{2}" target="_blank"><img src="{3}" class="qq-thumbnail-selector check_img" qq-max-size="100" qq-server-scale><span class="qq-upload-file-selector check_span" title="{1}">{1}</span></a>\
                <?php if(1 == $isEdit) echo '<img src="http://jbyoss.oss-cn-beijing.aliyuncs.com/public/web_img/App/deleteImg.png" alt="" class="qq-upload-cancel-selector qq-upload-cancel deleteImg check_close">\\'; ?>
        </div>\
        </li>';
         var uploadIndex = 0;
        <volist name="formParas" id="formParasSub">
        <if condition="$formParasSub.category eq INPUT_CATEGORY_UPLOAD">
              !function(){
                  var uploadedObject = eval('(' + '<?php echo json_encode($formParasSub['value']); ?>' + ')');
                  var htmls = Array();
                  var uploadedObjectSecond = Array();
                  $(uploadedObject).each(
                          function(i,n){
                              var obj = {};
                              if(n.file_name && n.file_path) {
                                  obj.vid = n.vid;
                                  obj.vid_fullpath = n.vid_fullpath;
                                  obj.file_name = n.file_name;
                                  obj.file_path = n.file_path;
                                  uploadedObjectSecond.push(obj);
                                  htmls.push(itemTemplate.format(-1 - i, n.file_name, obj.file_path, getThumbNail(n.file_path)))
                              }
                          })
                  uploader.initUploadedObject(++uploadIndex,uploadedObjectSecond, htmls);
                  $(".uploadImg{$key}").click(function(){
                      $("#fine-uploader_{$key}").find(':file').trigger('click');
                  });

              }();
         </if>
        </volist>

        window.check=function()
        {


            var uploaderLength = $('.uploader').length;
            if(0 != uploaderLength)
            {
                var uploadError = false;
                $('.uploader').each(function(i,n){
                    var imgPath = '';
                    var uploadInfo = uploader.getUploadInfo(i+1);
                    if (false == uploadInfo)
                    {
                        uploadError = true;
                        return false;
                    }
                    if($(n).siblings('input').attr('required'))
                    {
                        if(Object.keys(uploadInfo).length == 0)
                        {
                            var title = $(n).siblings('.titleName').text();
                            $.NotifyBox.NotifyPromptOne('提示',title+'未上传','确定');
                            uploadError = true;
                            return false;
                        }

                    }
                    $(n).siblings('input').val(JSON.stringify(uploadInfo));
                })
                if(uploadError)
                {
                    return false;
                }
            }
            var checkError = false;
            $('#submitForm:input').each(function(i,n){
                if($(n).attr('required') && $(n).val()=='')
                {
                    alert('请填写'+$(n).siblings('label').text() );
                    checkError = true;
                    return false;
                }
                if($(n).val()!='' && $(n).attr('type')!='hidden' && $(n).attr('reg')!='')
                {
                    var test = eval($(n).attr('reg'));
                    if(!test.test($(n).val()))
                    {
                        alert($(n).siblings('label').text() + '输入错误')
                        checkError = true;
                        return false;
                    }

                }
            })
            if(checkError)
                return false;

        }
        });
</script>
<script src="__PUBLIC__/js/jquery.form.js"></script>
<script>

    $(function() {
        var options = {
            success: showResponse, // post-submit callback
            resetForm: false,
            dataType: 'json',
            beforeSubmit: check
        };

        // bind to the form's submit event
        $('#submitForm').submit(function () {
            $(this).ajaxSubmit(options);
            return false;
        });


        function showResponse(responseText, statusText) {
            if(responseText == null)
            {
                $.NotifyBox.NotifyPromptOne('提示','服务器繁忙，请稍候再试','确定');
                $('#submitBtn').attr('disabled', false);
                return;
            }
            switch (responseText.status) {
                case 200:
                    $.NotifyBox.NotifyOneCall('提示','提交成功','确定',function(){
                        history.go(-1);
                    });
                    break;
                default:
                    $.NotifyBox.NotifyPromptOne('提示',responseText.message,'确定');
                    $('#submitBtn').attr('disabled', false);
                    break;
            }
        }
    })

</script>
